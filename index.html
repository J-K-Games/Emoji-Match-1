<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Emoji Match 3 ‚Äî JK Games</title>
<style>
  :root{
    --bg:#110a1f;
    --fg:#ffffff;
    --accent:#7c5cff;
    --accent-2:#00d1ff;
    --muted:#b7b3c9;
    --tile:#3b2a63;
    --grid-gap:6px;
    --tile-size: 48px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html,body{ height:100%; }
  body{ margin:0; color:var(--fg); background:var(--bg); overflow:hidden;
        font:500 16px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Emoji, "Apple Color Emoji","Segoe UI Emoji"; }
  #app{ height:100svh; width:100vw; display:grid; grid-template-rows: 56px 1fr auto 72px; }
  header{ display:flex; align-items:center; justify-content:space-between; padding:0 .75rem;
          background:linear-gradient(180deg,#1c1334,#18102d); border-bottom:1px solid #2a2146; }
  .brand{ display:flex; align-items:center; gap:.5rem; font-weight:700; }
  .dot{ width:10px;height:10px;border-radius:50%;background:conic-gradient(from 180deg,var(--accent),var(--accent-2)); box-shadow:0 0 12px #7c5cff88; }
  .btn{ border:0; border-radius:999px; padding:.5rem .9rem; background:#2a2146; color:#fff; font-weight:600; cursor:pointer; }
  .btn.small{ padding:.35rem .7rem; font-size:.9rem; }
  .btn.primary{ background: linear-gradient(180deg, #6f5cff, #5a46f9); }
  .btn.warn{ background: linear-gradient(180deg, #ff6b6b, #ff3b3b); }
  .badge{ background:#241945; border:1px solid #3a2c63; border-radius:999px; padding:.35rem .7rem; font-size:.9rem; color:#cfcbe6; }
  .chip{ background:#23183d; border:1px solid #3a2c63; border-radius:10px; padding:.2rem .5rem; color:#cfcbe6; }

  main{ position:relative; isolation:isolate; display:grid; grid-template-rows: 1fr auto; }
  #bgCanvas{ position:absolute; inset:0; z-index:0; pointer-events:none; }
  .layer{ position:relative; z-index:2; }

  /* Board */
  #board-wrap{ display:grid; place-items:center; padding:.6rem; }
  #board{
    display:grid;
    grid-template-columns: repeat(8, var(--tile-size));
    grid-template-rows: repeat(8, var(--tile-size));
    gap: var(--grid-gap);
    background:#2a1d4b;
    border-radius:20px;
    padding:var(--grid-gap);
    box-shadow: 0 10px 30px #00000033, inset 0 0 0 2px #4a3b73;
    width: calc((var(--tile-size) * 8) + (var(--grid-gap) * 7) + (var(--grid-gap) * 2));
    height: calc((var(--tile-size) * 8) + (var(--grid-gap) * 7) + (var(--grid-gap) * 2));
    max-width: 96vw; max-height: 64vh;
  }
  .tile{
    user-select:none; display:grid; place-items:center;
    font-size: calc(var(--tile-size) * .7);
    background: var(--tile);
    border-radius:14px;
    box-shadow: 0 6px 10px #00000033, inset 0 0 0 1.5px #5a4c86;
    transition: transform .16s ease, opacity .2s ease, filter .2s ease;
    touch-action:none;
  }
  .tile.matching{ animation: pop .32s ease forwards; }
  @keyframes pop{ 0%{ transform:scale(1); } 50%{ transform:scale(.7);} 100%{ transform:scale(0); opacity:0; } }
  .float{ position:fixed; pointer-events:none; font-weight:800; text-shadow: 0 2px 10px #0006; }

  /* Powerups */
  #powerups{ display:flex; gap:.9rem; justify-content:center; align-items:center; padding:.5rem .75rem calc(.8rem + var(--safe-bottom)); flex-wrap:wrap; }
  .pup{ position:relative; width:66px; height:66px; border-radius:50%; background:#2a1d4b; display:grid; place-items:center; border:2px solid #3b2c63; box-shadow:0 6px 12px #00000044; cursor:pointer; }
  .pup .label{ position:absolute; top:-1.2rem; width:100%; text-align:center; font-size:.75rem; color:#c2bed6; }
  .pup .cnt{ position:absolute; right:-6px; bottom:-6px; background:#121; border:1px solid #3b2c63; width:24px; height:24px; border-radius:50%; display:grid; place-items:center; font-size:.85rem; }

  /* Footer */
  footer{ position:relative; z-index:10; display:flex; align-items:center; justify-content:space-between; padding:.5rem .75rem calc(.75rem + var(--safe-bottom)); background:linear-gradient(180deg,#18102d,#140c24); border-top:1px solid #2a2146; }
  .round{ width:50px; height:50px; border-radius:50%; display:grid; place-items:center; background:#2a1d4b; border:2px solid #3a2c63; }

  /* Modals */
  dialog{ border:1px solid #3a2c63; border-radius:16px; padding:0; width:min(96vw, 620px); color:#fff; background:linear-gradient(180deg, #1b1230, #120b22); }
  dialog::backdrop{ background:#0008; }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:.9rem 1rem; border-bottom:1px solid #2a2146; }
  .modal-body{ padding:1rem; max-height:70svh; overflow:auto; }
  .list{ display:grid; gap:.5rem; }
  .row{ display:flex; align-items:center; justify-content:space-between; background:#23183d; padding:.6rem .75rem; border-radius:12px; }
  .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:.75rem; }
  .field input{ background:#23183d; border:1px solid #3a2c63; border-radius:10px; color:#fff; padding:.6rem .7rem; outline:none; width:100%; }
  .help{ color:#c2bed6; font-size:.9rem; }
  .title{ font-weight:800; font-size:1.1rem; margin-bottom:.35rem; }

  /* Performance themes */
  body.low{ background:#6b3fd1; }
  body.mid{ background:#342857; }
  body.high{ background:#110a1f; }
  body.ultra{ background:#0a0d1f; }
  body.low #bgCanvas{ display:none; } /* kein Canvas in Low */
  body.mid #bgCanvas{ display:none; } /* Mid: statischer Flat-BG */
  body.high #bgCanvas{ display:block; }
  body.ultra #bgCanvas{ display:block; }
  /* Animations: Low = keine, Mid = nur swipe (kein pop) */
  body.low .tile{ transition:none !important; }
  body.low .tile.matching{ animation:none !important; opacity:0; }
  body.mid .tile.matching{ animation:none !important; opacity:0; }

  /* Error overlay */
  #err{ position:fixed; left:12px; bottom:calc(76px + var(--safe-bottom)); background:#ff3b30; color:#fff; padding:.5rem .7rem; border-radius:10px; font-size:.9rem; display:none; z-index:99; }

  /* Admin Panel */
  .adm-live{ background:#193d2a; border:1px solid #2a6b49; color:#bfffd7; }
  #adminSearch{ background:#23183d; border:1px solid #3a2c63; border-radius:10px; color:#fff; padding:.6rem .7rem; width:100%; }
  .adm-head, .adm-row{ display:grid; grid-template-columns: 1.2fr .8fr .8fr .6fr; gap:.5rem; align-items:center; }
  .adm-head{ color:#c2bed6; font-weight:700; margin-bottom:.4rem; }
  .adm-row{ background:#23183d; padding:.5rem .6rem; border-radius:10px; }
  .adm-row input{ width:100%; background:#21163a; border:1px solid #3a2c63; border-radius:8px; color:#fff; padding:.35rem .5rem; }
  .adm-actions{ display:flex; gap:.4rem; justify-content:flex-end; }
  #adminList{ display:grid; gap:.45rem; }
  .adm-empty{ color:#b7b3c9; font-style:italic; text-align:center; padding:.75rem; }


  /* --- Powerups: always visible + selected state --- */
  #powerups{
    position: sticky;
    bottom: calc(0px + var(--safe-bottom));
    z-index: 5;
    opacity: 1;
    filter: none;
    transform: none;
    padding-bottom: calc(.8rem + var(--safe-bottom));
  }
  .pup{
    transition: transform .15s ease, box-shadow .2s ease, outline-color .2s ease, border-color .2s ease;
    outline: 0 solid transparent;
  }
  .pup.selected{
    outline-width: 3px;
    outline-color: #8b7bff;
    box-shadow: 0 0 0 6px rgba(139,123,255,.18), 0 10px 16px rgba(0,0,0,.35);
    transform: translateY(-2px) scale(1.06);
  }
  .pup:active{ transform: translateY(1px) scale(.98); }

  /* --- Ultra transparency for board & tiles (shows animated background) --- */
  body.ultra{ 
    --tile: rgba(59, 42, 99, 0.5); /* tiles ~50% transparent */
  }
  body.ultra #board{
    background: rgba(42, 29, 75, 0.35); /* board frame ~35% transparent */
    box-shadow: 0 10px 30px rgba(0,0,0,0.2), inset 0 0 0 2px rgba(74,59,115,0.7);
  }

/* === Mobile Lock & Layout === */
html, body { overscroll-behavior: none !important; height: 100%; width: 100%; }
body { position: fixed !important; overflow: hidden !important; inset: 0; touch-action: none !important; }
[data-scrollable] { overflow: auto !important; -webkit-overflow-scrolling: touch !important; overscroll-behavior: contain !important; max-height: 80vh;  touch-action: pan-y !important; -ms-touch-action: pan-y !important;}

@media (max-width: 640px) {
  header { display: grid; grid-template-columns: 1fr; grid-auto-rows: auto; row-gap: .4rem; justify-items: start; }
  .brand { display: grid; grid-auto-flow: column; grid-auto-columns: max-content; gap: .4rem; align-items: center; justify-items: start; }
  .brand .dot { display: none; }
  #score, #points { margin: 0; }
  #btnPerf { justify-self: start; }
  #btnTop, #btnRestart { width: 100%; }
}

/* --- OFFICIAL v11: Konto scroll fix --- */

/* --- OFFICIAL v12: Konto deep scroll & bottom-safe padding --- */
:root{ --safe-bottom: env(safe-area-inset-bottom, 0px); }
.modal-body { 
  max-height: calc(100dvh - 96px) !important; 
  overflow-y: auto !important; 
  -webkit-overflow-scrolling: touch !important; 
  overscroll-behavior: contain !important;
}
.modal-body[data-scrollable]{
  padding-bottom: calc(200px + var(--safe-bottom)) !important; /* make space for last buttons */
}

.modal-body[data-scrollable],
#dlgAccount .modal-body,
#accountPanel .modal-body,
#account, #konto, [data-panel="konto"], [aria-labelledby="tab-konto"] {
  max-height: calc(100vh - 140px) !important;
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch !important;
  overscroll-behavior: contain !important;
  touch-action: pan-y !important;
}
body.modal-open { overscroll-behavior-y: none; }
.modal-body input, .modal-body select, .modal-body textarea { font-size: 16px; }


/* v18 chip style */ 
.chip{ display:inline-flex; gap:.4rem; align-items:center; padding:.2rem .6rem; border-radius:999px; background:#2a2146; color:#e8e6ff; font-size:.85rem; border:1px solid #3a2c63; }

  /* Quests progress bar */
  .qprog{ width:100%; height:10px; border-radius:999px; background:#1d1334; overflow:hidden; border:1px solid #3a2c63; }
  .qprog > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg, #7c5cff, #00d1ff); }

/* Toast for save feedback */
#toastSave{
  position: fixed;
  right: 16px;
  bottom: 16px;
  z-index: 10000;
  padding: 10px 14px;
  border-radius: 12px;
  background: rgba(40, 210, 120, 0.9);
  color: #0b1b12;
  font-weight: 700;
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
  opacity: 0;
  transform: translateY(8px);
  pointer-events: none;
  transition: opacity .25s ease, transform .25s ease;
}
#toastSave.show{ opacity: 1; transform: translateY(0); }
#toastSave.error{ background: rgba(255, 90, 90, 0.92); color: #2a0b0b; }
</style>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"><style>
/* ==== Mobile refinement v5 ==== */
@media (max-width: 768px), (pointer: coarse) {
  /* header slightly thicker so perf bar fits */
  header, .header, .topbar {
    min-height: 72px !important;
    padding-top: 10px !important;
    padding-bottom: 10px !important;
  }
  /* performance bar scale (applied via JS) */
  .perfbar--mobile-scale { transform: scale(0.86); transform-origin: left top; }
  /* vertical actions small pills */
  .floating-mobile-action { font-size: 14px !important; padding: 8px 10px !important; border-radius: 12px !important; }
  /* reload baseline at bottom */
  .btn-reload-mobile { bottom: calc(var(--safe-bottom, 0px) + 6px) !important; }
}
</style>
<style>
/* ==== Mobile refinement v6 (safe header + mini actions) ==== */
@media (max-width: 768px), (pointer: coarse) {
  header, .header, .topbar {
    min-height: 72px !important;   /* slightly thicker */
    padding-top: 10px !important;
    padding-bottom: 10px !important;
    position: relative;
    z-index: 1000;
  }
  .header-right-stack {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 6px;
  }
  .mini-top-btn {
    font-size: 12px;
    line-height: 1;
    padding: 8px 10px;
    border-radius: 9999px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.25);
    backdrop-filter: blur(6px);
    color: var(--fg, #fff);
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  .mini-top-btn:active { transform: scale(0.97); }
  /* Ensure any previous floating styles don't interfere */
  .floating-mobile-action {
    position: static !important;
    top: auto !important; right: auto !important; left: auto !important;
    z-index: auto !important;
  }
  /* Keep bottom HUD really at the bottom */
  .hud-bottom-fixed {
    position: fixed !important;
    left: 0; right: 0;
    bottom: calc(var(--safe-bottom, 0px) + 4px) !important;
    z-index: 900;
  }
  .btn-reload-mobile {
    position: fixed !important;
    bottom: calc(var(--safe-bottom, 0px) + 4px) !important;
    z-index: 9999;
  }
}
</style>
<style>
/* ==== Mobile refinement v7 (match perf-chip look, vertical stack, no reload) ==== */
@media (max-width: 768px), (pointer: coarse) {
  header, .header, .topbar {
    min-height: 72px !important;
    padding-top: 10px !important;
    padding-bottom: 10px !important;
    position: relative;
    z-index: 1000;
  }
  .header-right-stack {
    position: absolute;
    right: 8px;
    top: 6px;             /* a bit higher as requested */
    transform: none;      /* cancel previous centering */
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: flex-end;
    pointer-events: none; /* container non-interactive... */
  }
  .header-right-stack > * {
    pointer-events: auto; /* ...buttons stay clickable */
  }
  /* Ensure our cloned perf-chip sized buttons render like chips */
  .mini-top-btn.match-perf-chip {
    /* keep minimal reset only; visual style comes from cloned classes */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
  }
  /* Make sure any old floating styles are neutralized */
  .floating-mobile-action { position: static !important; top:auto !important; right:auto !important; left:auto !important; z-index:auto !important; }
  /* Kill space for reload button */
  .btn-reload-mobile { display: none !important; }
}
</style>

<!-- EM3 force-cloud-sync shim -->
<script>
(() => {
  const isHosted = (location.protocol === 'https:')
                || /\.github\.io$/i.test(location.hostname)
                || location.hostname === 'localhost';
  try {
    if (isHosted) {
      // Hint flags for the app to use Firebase/remote DB instead of local-only mode.
      localStorage.setItem('EM3_SYNC_MODE', 'firebase');
      localStorage.setItem('EM3_REQUIRE_REMOTE', '1');
      localStorage.setItem('EM3_DISABLE_LOCAL_WARNING', '1');
    }
  } catch(e) {}
})();
</script>


</head>
<body class="high">
<div id="app">
  <header>
    <div class="brand">
      <span class="dot"></span><span id="brandText">e.m.3</span>
      <span id="score" class="badge">Score: 0</span>
      <span id="points" class="badge">Punkte: 0</span>
    </div>
    <div class="hdr-actions">
      <button id="btnPerf" class="btn small" title="Performance umschalten">Performance: Hoch</button>
      <button id="btnTop" class="btn primary small">Bestenliste</button>
      <button id="btnRestart" class="btn warn small">Neustart</button>
    </div>
    <button id="btnSave" class="btn small" title="Jetzt speichern">Speichern</button>
</header>

  <main>
    <canvas id="bgCanvas" width="1280" height="720" aria-hidden="true"></canvas>
    <div class="layer" id="board-wrap">
      <div id="board" aria-label="Spielfeld 8x8"></div>
    </div>

    <div class="layer" id="powerups" aria-label="Power-Ups">
      <div class="pup" id="pupRefresh" title="Refresh"><div class="label">Refresh</div>üîÑ<div class="cnt" id="cntRefresh">1</div></div>
      <div class="pup" id="pupRocket" title="Rocket"><div class="label">Rocket</div>üöÄ<div class="cnt" id="cntRocket">0</div></div>
      <div class="pup" id="pupBomb" title="Bombe"><div class="label">Bombe</div>üí£<div class="cnt" id="cntBomb">0</div></div>
      <div class="pup" id="pupDestroy" title="Destroy"><div class="label">Destroy</div>‚ùå<div class="cnt" id="cntDestroy">0</div></div>
    </div>
  </main>

  <footer>
    <button id="btnAccount" class="round" title="Konto / Inventar / Shop">üë§</button>
    <button id="btnQuests" class="round" title="Tagesziele / Quests">üéØ</button>
    <button id="btnInfo" class="btn small">Info</button>
    <div id="fpsBox" class="badge">FPS: 60</div>
  </footer>
</div>

<div id="err">
<!-- Admin Login -->
<dialog id="dlgAdminLogin">
  <div class="modal-header">
    <div style="font-weight:800;">Admin Login</div>
    <button class="btn small" onclick="document.getElementById('dlgAdminLogin').close()">Schlie√üen</button>
  </div>
  <div class="modal-body" data-scrollable>
    <div class="help" style="margin-bottom:.6rem;">√ñffne mit <b>Strg + Alt + #</b>. Bitte Passwort eingeben:</div>
    <div class="grid-2">
      <div class="field"><label>Passwort</label><input id="admPass" type="password" placeholder="Passwort" /></div>
      <div style="display:flex; align-items:flex-end; gap:.5rem;">
        <button id="btnAdmLogin" class="btn primary">Anmelden</button>
        <button id="btnAdmCancel" class="btn">Abbrechen</button>
      </div>
    </div>
    <div id="admMsg" class="help" style="margin-top:.5rem;"></div>
  </div>
</dialog>

<!-- Admin Panel -->
<dialog id="dlgAdmin">
  <div class="modal-header">
    <div style="display:flex; align-items:center; gap:.5rem;">
      <div style="font-weight:800;">Admin ‚Äî Spieler√ºbersicht</div>
      <div class="chip adm-live">LIVE</div>
    </div>
    <button class="btn small" onclick="document.getElementById('dlgAdmin').close()">Schlie√üen</button>
  </div>
  <div class="modal-body" data-scrollable>
    <div class="grid-2" style="margin-bottom:.6rem;">
      <div class="field"><input id="adminSearch" placeholder="Spieler suchen (Name enth√§lt ‚Ä¶)" /></div>
      <div class="field"><div id="adminStats" class="help" style="padding:.6rem .2rem;">Lade Spieler‚Ä¶</div></div>
    </div>
    <div class="adm-head">
      <div>Spieler</div><div>Aktueller Score</div><div>Kontostand (Punkte)</div><div>Aktion</div>
    </div>
    <div id="adminList"></div>
  </div>
</dialog>
</div>


<!-- Quests / Tagesziele -->
<dialog id="dlgQuests">
  <div class="modal-header">
    <div style="display:flex; align-items:center; gap:.5rem;">
      <div style="font-weight:800;">Tagesziele</div>
      <div class="chip">t√§glich</div>
    </div>
    <button class="btn small" onclick="document.getElementById('dlgQuests').close()">Schlie√üen</button>
  </div>
  <div class="modal-body" data-scrollable>
    <div id="questsActiveBuffs" class="help" style="margin-bottom:.6rem;"></div>
    <div id="questsList" class="list"></div>
    <div class="help" style="margin-top:.6rem;">Neue Ziele jeden Tag. Belohnungen: zeitweise doppelte Punkte pro Feld, extra ‚Ç¨ pro Feld oder Sofort-Guthaben.</div>
  </div>
</dialog>


<!-- Info -->
<dialog id="dlgInfo">
  <div class="modal-header">
    <div style="font-weight:800;">Spielinfo</div>
    <button class="btn small" onclick="document.getElementById('dlgInfo').close()">Schlie√üen</button>
  </div>
  <div class="modal-body" data-scrollable>
    <div class="title">So funktioniert es</div>
    <ol>
      <li><b>Spielfeld:</b> 8√ó8, drei oder mehr gleiche zusammenwischen. Jede Kachel 10 Punkte.</li>
      <li><b>Power-Ups:</b> Refresh (1√ó/Runde), Rocket (4er), Bombe (5+), Destroy (15√ó Dreier).</li>
      <li><b>Performance:</b> Niedrig (ohne Animationen), Mittel (nur Wisch + Punkte-Popups),
          Hoch (Galaxy statisch, alle Anims), Ultra (Tag/Nacht, Wolken/Meteore; Best√§tigung n√∂tig).</li>
      <li><b>Bestenliste:</b> Top 10; bist du 11+, wird dein Rang extra angezeigt.</li>
      <li><b>Konto:</b> Punkte = Guthaben; Troph√§en bei 10k/40k/70k/100k/150k/200k; Shop &amp; Spielfeld anpassen.</li>
    </ol>
  </div>
</dialog>

<!-- Konto / Inventar / Shop -->
<dialog id="dlgAccount">
  <div class="modal-header">
    <div style="font-weight:800;">Konto</div>
    <div class="chip" id="chipUser">Abgemeldet</div><div class="chip" title="Cloud-Modus">OFFICIAL</div>
    <button class="btn small" onclick="document.getElementById('dlgAccount').close()">Schlie√üen</button>
  </div>
  <div class="modal-body" data-scrollable>
    <div id="accNotLogged">
      <div class="grid-2">
        <div class="field"><label>Benutzername</label><input id="inpUser" placeholder="Name" maxlength="20"></div>
        <div class="field"><label>Passwort</label><input id="inpPass" type="password" placeholder="Passwort"></div>
      </div>
      <div style="display:flex;gap:.5rem;justify-content:center;margin-top:.75rem;">
        <button id="btnLogin" class="btn primary">Login</button>
        <button id="btnSignup" class="btn">Konto erstellen</button>
      </div>
      <div id="accMsg" class="help" style="margin-top:.4rem;">Name muss eindeutig sein.</div>
    </div>

    <div id="accLogged" style="display:none;">
      <div class="list">
        <div class="row"><div>üë§ <b id="accName">---</b></div><div><button id="btnRename" class="btn small">Namen √§ndern (20.000)</button></div></div>
        <div class="row"><div>üí∞ Kontostand: <b id="accPoints">0</b></div><div>Bestscore: <b id="accBest">0</b></div></div>
      </div>

      <div class="title" style="margin-top:.8rem;">Einstellungen</div>
      <div class="list">
        <div class="row"><div>üéµ Musik</div><div><button id="btnMusic" class="btn small">AUS</button></div></div>
        <div class="row"><div>üîä Sound</div><div><button id="btnSound" class="btn small">AUS</button></div></div>
        <div class="row"><div>üéº Eigene Musik (YouTube)</div><div><input id="ytUrl" placeholder="YouTube-Link" style="width:14rem;" class="field-input"></div></div>
        <div class="row" style="justify-content:center;"><button id="btnYTPlay" class="btn small primary">YouTube starten</button></div>
<div class="row" style="gap:.5rem; justify-content:center; margin-top:.35rem;">
  <button id="btnPauseYT" class="btn small">Pause</button>
  <button id="btnStopYT" class="btn small">Stop</button>
</div>

        <div class="title" style="margin-top:.8rem;">Design</div>
        <div class="help">Hintergr√ºnde &amp; Spielfeld</div>
        <div class="row" style="justify-content:center;">
          <button id="btnDesignOpen" class="btn small">Hintergr√ºnde anpassen</button>
        </div>


      </div>

      <div class="title" style="margin-top:.8rem;">Troph√§en</div>
      <div class="help">10k ü•â, 40k ü•à, 70k ü•á, 100k üèÖ, 150k üéñ, 200k üèÜ ‚Äì ausw√§hlbar f√ºr Bestenliste.</div>
      <div id="trophyList" class="list"></div>

      <div class="title" style="margin-top:.8rem;">Shop</div>
      <div class="list">
        <div class="row"><div>üõí Emoji-Shop</div><div><button id="btnShop" class="btn small primary">√ñffnen</button></div></div>
        <div class="row"><div>üéõÔ∏è Spielfeld anpassen</div><div><button id="btnCustomize" class="btn small">Ausw√§hlen</button></div></div>
      </div>
    </div>
  </div>
</dialog>

<!-- Shop -->
<dialog id="dlgShop">
  <div class="modal-header"><div style="font-weight:800;">Emoji-Shop ‚Äî 10.000 Punkte</div>
    <button class="btn small" onclick="document.getElementById('dlgShop').close()">Schlie√üen</button></div>
  <div class="modal-body" data-scrollable>
    <div class="field" style="margin-bottom:.5rem;"><input id="shopSearch" placeholder="Emoji suchen (z. B. üçì)" /></div>
    <div id="shopGrid" style="display:grid; grid-template-columns: repeat(6, 1fr); gap:.5rem;"></div>
  </div>
</dialog>

<!-- Customize -->
<dialog id="dlgCustom">
  <div class="modal-header"><div style="font-weight:800;">Spielfeld anpassen</div>
    <button class="btn small" onclick="document.getElementById('dlgCustom').close()">Schlie√üen</button></div>
  <div class="modal-body" data-scrollable>
    <div class="help">W√§hle genau 8 Emojis. Standard sind vorausgew√§hlt.</div>
    <div id="customGrid" style="display:grid; grid-template-columns: repeat(8, 1fr); gap:.5rem; margin-top:.5rem;"></div>
    <div style="text-align:right;margin-top:.6rem;"><button id="btnSaveCustom" class="btn small primary">Speichern</button></div>
  </div>
</dialog>

<!-- Bestenliste -->
<dialog id="dlgTop">
  <div class="modal-header"><div style="font-weight:800;">Bestenliste (Top 10)</div>
    <button class="btn small" onclick="document.getElementById('dlgTop').close()">Schlie√üen</button></div>
  <div class="modal-body" data-scrollable><div id="topList" class="list"></div></div>
</dialog>

<div id="ytWrap" style="position:fixed; inset:auto 0 0 0; height:0; overflow:hidden;"></div>

<script type="module">
/* ---------- Error overlay ---------- */
const errBox = document.getElementById('err');
window.addEventListener('error', (e)=>{ errBox.style.display='block'; errBox.textContent = 'Fehler: ' + (e.message || e.error); });

/* ---------- Firebase (guarded) ---------- */
let db=null, fb=null;
const FB_APP_VER = "10.12.4";
(async ()=>{
  try{
    const { initializeApp } = await import(`https://www.gstatic.com/firebasejs/${FB_APP_VER}/firebase-app.js`);
    const { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, orderBy, limit, getDocs, onSnapshot, where, runTransaction, serverTimestamp } =
      await import(`https://www.gstatic.com/firebasejs/${FB_APP_VER}/firebase-firestore.js`);
    const { getAuth, signInAnonymously } = await import(`https://www.gstatic.com/firebasejs/${FB_APP_VER}/firebase-auth.js`);
    const app = initializeApp({
      apiKey: "AIzaSyBa-8wKtWpiFVFeUrNJedjYsuIQLbI0JLQ",
      authDomain: "j-k--games.firebaseapp.com",
      projectId: "j-k--games",
      storageBucket: "j-k--games.firebasestorage.app",
      messagingSenderId: "779886305498",
      appId: "1:779886305498:web:d8e0f24b214805904285e3",
      measurementId: "G-YE25QXV7PV"
    });
    // Anonymous Auth to satisfy Firestore rules (request.auth != null)
    const auth = getAuth(app);
    try {
      await signInAnonymously(auth);
      window._authed = true;
    } catch(e){
      console.warn("Anonymous auth failed (enable in Firebase Console):", e);
    }
    window.auth = auth;

    db = getFirestore(app);
    fb = {doc,setDoc,getDoc,updateDoc,collection,query,orderBy,limit,getDocs,onSnapshot,where,runTransaction,serverTimestamp};
    window.db=db; window.fb=fb;
  }catch(e){ console.log("Firebase nicht verf√ºgbar:", e); }
})();

/* ---------- Helpers ---------- */
function showToast(msg, ms=1200){
  const t=document.createElement('div'); t.textContent=msg; t.style.position='fixed'; t.style.left='50%'; t.style.bottom='96px'; t.style.transform='translateX(-50%)'; t.style.background='#2a1d4b'; t.style.border='1px solid #3a2c63'; t.style.borderRadius='12px'; t.style.padding='.5rem .8rem'; t.style.zIndex='120'; t.style.boxShadow='0 6px 12px #0006'; document.body.appendChild(t);
  setTimeout(()=>{ t.remove(); }, ms);
}

const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h|=0; } return String(h); }

/* ---------- Sizing (bigger board) ---------- */
function computeTileSize(){
  const headerH = document.querySelector('header').offsetHeight || 56;
  const footerH = document.querySelector('footer').offsetHeight || 72;
  const powerH = document.querySelector('#powerups').offsetHeight || 90;
  const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--grid-gap')) || 6;
  const pad = 24;
  const availH = window.innerHeight - headerH - footerH - powerH - pad;
  const availW = window.innerWidth - pad;
  const minSide = Math.min(availW, availH);
  const boardSize = clamp(minSide*0.97, 340, 620); /* gr√∂√üer */
  const tile = Math.floor((boardSize - gap*7 - gap*2) / 8);
  document.documentElement.style.setProperty('--tile-size', tile + 'px');
}
addEventListener('resize', computeTileSize);

/* ---------- Background (High/Ultra) ---------- */
const bg = document.getElementById('bgCanvas');
const ctx = bg.getContext('2d');
let stars = Array.from({length:150}, ()=>({x:Math.random(), y:Math.random(), s:Math.random()*1.5+0.2, sp:Math.random()*0.02+0.005}));
let meteors = [], dayT=0, lastFrame=performance.now();
function resizeCanvas(){ bg.width=innerWidth*devicePixelRatio; bg.height=innerHeight*devicePixelRatio; ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); }
addEventListener('resize', resizeCanvas); resizeCanvas();
let perfMode = localStorage.getItem("perfMode") || "high";
function bgHigh(dt){
  const w=innerWidth,h=innerHeight;
  const g=ctx.createRadialGradient(w*0.6,h*0.3,0,w*0.6,h*0.3,Math.max(w,h));
  g.addColorStop(0,"#1a1740"); g.addColorStop(1,"#0a081a"); ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
  for(const st of stars){ const x=st.x*w, y=st.y*h; const a=0.5+0.5*Math.sin((performance.now()*st.sp)/500); ctx.fillStyle=`rgba(255,255,255,${0.2+0.8*a})`; ctx.fillRect(x,y,st.s,st.s); }
}
function bgUltra(dt){
  const w=innerWidth, h=innerHeight;
  dayT += dt*0.00003; const phase=(Math.sin(dayT)+1)/2;
  const top=`rgb(${Math.round(10+60*phase)},${Math.round(10+70*phase)},${Math.round(30+120*phase)})`;
  const bot=`rgb(${Math.round(10+30*phase)},${Math.round(10+20*phase)},${Math.round(50+150*phase)})`;
  const g=ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,top); g.addColorStop(1,bot); ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
  const sunX=w*(0.1+0.8*phase), sunY=h*(0.8-0.6*phase); ctx.fillStyle="rgba(255,240,180,0.9)"; ctx.beginPath(); ctx.arc(sunX,sunY,30,0,Math.PI*2); ctx.fill();
  const night=1-phase;
  if(night>0.3){
    for(const st of stars){ const x=st.x*w, y=st.y*h; const a=night*(0.3+0.7*Math.sin((performance.now()*st.sp)/500)); ctx.fillStyle=`rgba(255,255,255,${a})`; ctx.fillRect(x,y,st.s,st.s); }
    if(Math.random()<0.003 && meteors.length<2){ meteors.push({x:Math.random()*w,y:-20,vx:4+Math.random()*3,vy:4+Math.random()*3,life:1}); }
    ctx.strokeStyle="rgba(255,255,255,.9)"; ctx.lineWidth=2;
    meteors.forEach(m=>{ ctx.beginPath(); ctx.moveTo(m.x,m.y); ctx.lineTo(m.x-12,m.y-12); ctx.stroke(); m.x+=m.vx; m.y+=m.vy; m.life-=0.01; });
    meteors = meteors.filter(m=> m.y<h+40 && m.life>0);
  } else {
    ctx.fillStyle="rgba(255,255,255,0.8)";
    for(let i=0;i<6;i++){ const cx=(performance.now()/50+i*180)%(w+160)-80; const cy=80+i*18+20*Math.sin(i+performance.now()/2000);
      ctx.beginPath(); ctx.ellipse(cx,cy,50,18,0,0,Math.PI*2); ctx.ellipse(cx+26,cy-8,34,14,0,0,Math.PI*2); ctx.ellipse(cx-26,cy-6,36,16,0,0,Math.PI*2); ctx.fill();
    }
  }
}
let fpsSamples=[];
function loop(ts){
  const dt = ts - lastFrame; lastFrame = ts;
  if(perfMode==="high") bgHigh(dt); else if(perfMode==="ultra") bgUltra(dt); else ctx.clearRect(0,0,bg.width,bg.height);
  const f = 1000/Math.max(1, dt); fpsSamples.push(f); if(fpsSamples.length>12) fpsSamples.shift();
  const avg = Math.round(fpsSamples.reduce((a,b)=>a+b,0)/fpsSamples.length);
  const fpsBox = document.getElementById('fpsBox');
  fpsBox.textContent = "FPS: " + (perfMode==="low"?30 : perfMode==="mid"?60 : perfMode==="high"?Math.min(60,avg) : Math.min(120,avg));
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function setPerf(mode){
  perfMode = mode;
  localStorage.setItem("perfMode", mode);
  document.body.classList.remove("low","mid","high","ultra");
  document.body.classList.add(mode);
  document.getElementById('btnPerf').textContent = "Performance: " + (mode==="low"?"Niedrig":mode==="mid"?"Mittel":mode==="high"?"Hoch":"Ultra");
}

/* ---------- Audio (SFX + Music) ---------- */
const AudioSys = (function(){
  let ctx=null, master, sfxGain, musicGain, musicTimer=null, musicOn=false, sfxOn=true;
  function ensureCtx(){
    if(!ctx){ ctx = new (window.AudioContext||window.webkitAudioContext)();
      master = ctx.createGain(); master.gain.value = 0.9; master.connect(ctx.destination);
      sfxGain = ctx.createGain(); sfxGain.gain.value = 0.8; sfxGain.connect(master);
      musicGain = ctx.createGain(); musicGain.gain.value = 0.25; musicGain.connect(master);
    }
    if(ctx.state==="suspended") ctx.resume();
  }
  function env(duration=0.15){ const g=ctx.createGain(); g.gain.setValueAtTime(0, ctx.currentTime); g.gain.linearRampToValueAtTime(1, ctx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+duration); return g; }
  function beep(freq=600, dur=0.12){ if(!sfxOn) return; ensureCtx(); const o=ctx.createOscillator(); o.type="sine"; o.frequency.setValueAtTime(freq, ctx.currentTime); const g=env(dur); o.connect(g).connect(sfxGain); o.start(); o.stop(ctx.currentTime+dur); }
  function thud(){ if(!sfxOn) return; ensureCtx(); const o=ctx.createOscillator(); o.type="triangle"; o.frequency.setValueAtTime(120, ctx.currentTime); const g=env(0.2); g.gain.value=1.2; o.connect(g).connect(sfxGain); o.start(); o.frequency.exponentialRampToValueAtTime(60, ctx.currentTime+0.18); o.stop(ctx.currentTime+0.2); }
  function noiseBoom(){ if(!sfxOn) return; ensureCtx(); const b=ctx.createBuffer(1, ctx.sampleRate*0.4, ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,2); const src=ctx.createBufferSource(); src.buffer=b; const g=env(0.4); g.gain.value=1.4; src.connect(g).connect(sfxGain); src.start(); }
  function rocket(){ if(!sfxOn) return; ensureCtx(); const o=ctx.createOscillator(); o.type="sawtooth"; o.frequency.value=220; const g=env(0.5); g.gain.value=0.6; o.connect(g).connect(sfxGain); o.start(); o.frequency.exponentialRampToValueAtTime(880, ctx.currentTime+0.45); o.stop(ctx.currentTime+0.5); }
  function playMusic(){ if(musicOn) return; ensureCtx(); musicOn=true; // simple generative loop
    const scale=[0,2,4,7,9]; let root=220;
    musicTimer = setInterval(()=>{
      if(!musicOn) return;
      const t = Date.now()/1000;
      const step = (Math.floor(t*2)%8);
      const n1 = root*Math.pow(2, scale[(step+0)%scale.length]/12);
      const n2 = root*Math.pow(2, scale[(step+2)%scale.length]/12);
      const n3 = root*Math.pow(2, scale[(step+4)%scale.length]/12);
      [n1,n2,n3].forEach((f,k)=>{ const o=ctx.createOscillator(); o.type=k%2?"sine":"triangle"; o.frequency.setValueAtTime(f, ctx.currentTime); const g=ctx.createGain(); g.gain.value = 0.06 + 0.04*Math.random(); g.gain.setTargetAtTime(0, ctx.currentTime+0.4+0.1*k, 0.3); o.connect(g).connect(musicGain); o.start(); o.stop(ctx.currentTime+1.2); });
    }, 500);
  }
  function stopMusic(){ if(musicTimer){ clearInterval(musicTimer); musicTimer=null; } musicOn=false; }
  return {
    init(){ ensureCtx(); },
    setMusic(on){ on?playMusic():stopMusic(); },
    setSfx(on){ sfxOn=on; },
    sfx3(){ beep(620, .12); },
    sfx4(){ beep(760, .14); },
    sfx5(){ beep(920, .16); },
    sfxBad(){ thud(); },
    sfxRocket(){ rocket(); },
    sfxBomb(){ noiseBoom(); }
  }
})();


/* ---------- Quests / Tagesziele (daily) ---------- */
const QUESTS_KEY = "EM3_QUESTS_STATE";
function todayKey(){
  const d = new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}
function baseQuestSet(){
  return [
    { id:"reach10k",  text:"Erreiche 10.000 Score in einer Runde", type:"score", goal:10000, progress:0, done:false, claimed:false, reward:{ kind:"buffScore", mult:2, minutes:3 } },
    { id:"fiveFours", text:"Mache 5 Vierer-Kombos (Reihen mit 4)", type:"fourCombos", goal:5, progress:0, done:false, claimed:false, reward:{ kind:"buffMoneyPerTile", amount:5, minutes:5 } },
    { id:"fivePlus",  text:"Erzeuge eine 5er+ Kombo", type:"fivePlus", goal:1, progress:0, done:false, claimed:false, reward:{ kind:"instantMoney", amount:10000 } }
  ];
}
function loadQuests(){
  let s=null; try{ s=JSON.parse(localStorage.getItem(QUESTS_KEY)||"null"); }catch{}
  if(!s || s.date !== todayKey()){ s = { date: todayKey(), quests: baseQuestSet(), buffs: {} }; }
  s.buffs = s.buffs || {};
  if(typeof s.buffs.scoreUntil !== "number") s.buffs.scoreUntil = 0;
  if(typeof s.buffs.scoreMult !== "number") s.buffs.scoreMult = 1;
  if(typeof s.buffs.moneyUntil !== "number") s.buffs.moneyUntil = 0;
  if(typeof s.buffs.moneyPerTile !== "number") s.buffs.moneyPerTile = 0;
  return s;
}
function saveQuests(){ try{ localStorage.setItem(QUESTS_KEY, JSON.stringify(questsState)); }catch{} }
let questsState = loadQuests();

function getScorePerTile(){
  const BASE = 10;
  if(Date.now() < questsState.buffs.scoreUntil){ return Math.max(BASE, Math.floor(BASE * questsState.buffs.scoreMult)); }
  return BASE;
}
function getMoneyPerTile(){
  if(Date.now() < questsState.buffs.moneyUntil){ return questsState.buffs.moneyPerTile|0; }
  return 0;
}
function applyReward(rw){
  if(!rw) return;
  if(rw.kind === "buffScore"){
    questsState.buffs.scoreMult = rw.mult||2;
    questsState.buffs.scoreUntil = Date.now() + (rw.minutes||3)*60*1000;
    try{ showToast(`‚ö° Doppelte Punkte f√ºr ${rw.minutes||3} Min aktiv!`); }catch{}
  } else if(rw.kind === "buffMoneyPerTile"){
    questsState.buffs.moneyPerTile = rw.amount||5;
    questsState.buffs.moneyUntil = Date.now() + (rw.minutes||5)*60*1000;
    try{ showToast(`üí∏ +${rw.amount||5}‚Ç¨ pro Feld f√ºr ${rw.minutes||5} Min!`); }catch{}
  } else if(rw.kind === "instantMoney"){
    const add = rw.amount||5000; points += add; updatePoints(); try{ showToast(`+${add}‚Ç¨ Kontoguthaben`); }catch{}
  }
  saveQuests();
  renderQuests();
}
function markDoneIf(q, cond){ if(!q.done && cond){ q.done=true; saveQuests(); } }
function questOnScoreChanged(currScore){
  const qs = questsState.quests;
  const q1 = qs.find(q=>q.type==="score"); if(q1){ q1.progress = Math.max(q1.progress||0, currScore); markDoneIf(q1, q1.progress>=q1.goal); }
  saveQuests();
}
function questTrackMatches(matches){
  let four=0, five=0;
  for(const m of matches){ if(m.len===4) four++; if(m.len>=5) five++; }
  const qs = questsState.quests;
  const qF = qs.find(q=>q.type==="fourCombos");
  if(qF && !qF.done){ qF.progress = (qF.progress||0) + four; markDoneIf(qF, qF.progress>=qF.goal); }
  const q5 = qs.find(q=>q.type==="fivePlus");
  if(q5 && !q5.done){ q5.progress = (q5.progress||0) + (five>0?1:0); markDoneIf(q5, q5.progress>=q5.goal); }
  saveQuests();
}
function renderQuests(){
  const list = document.getElementById('questsList'); if(!list) return;
  list.innerHTML="";
  for(const q of questsState.quests){
    const pct = Math.min(100, Math.floor(( (q.progress||0) / q.goal )*100));
    const row = document.createElement('div'); row.className="row";
    row.innerHTML = `
      <div style="flex:1; min-width:0;">
        <div><b>${q.text}</b></div>
        <div class="help">${Math.min(q.progress||0,q.goal)} / ${q.goal}</div>
        <div class="qprog" aria-hidden="true"><i style="width:${pct}%"></i></div>
      </div>
      <div style="display:flex; align-items:center; gap:.4rem; margin-left:.5rem;">
        <div class="chip">${q.done ? (q.claimed ? "Abgeschlossen" : "Fertig!") : "L√§uft‚Ä¶"}</div>
        <button class="btn small ${q.done && !q.claimed ? 'primary' : ''}" ${q.done && !q.claimed ? '' : 'disabled'}>Claim</button>
      </div>
    `;
    const btn = row.querySelector('button');
    btn.onclick = ()=>{
      if(q.done && !q.claimed){ q.claimed=true; saveQuests(); applyReward(q.reward); }
    };
    list.appendChild(row);
  }
  const ab = document.getElementById('questsActiveBuffs');
  function fmt(ms){ const s=Math.max(0, Math.ceil(ms/1000)); const m=Math.floor(s/60), ss=s%60; return `${m}:${String(ss).padStart(2,'0')}`; }
  const now = Date.now();
  const lines = [];
  if(now < questsState.buffs.scoreUntil){ lines.push(`‚ö° Doppelte Punkte aktiv ‚Äî noch ${fmt(questsState.buffs.scoreUntil - now)}`); }
  if(now < questsState.buffs.moneyUntil){ lines.push(`üí∏ +${questsState.buffs.moneyPerTile}‚Ç¨ pro Feld ‚Äî noch ${fmt(questsState.buffs.moneyUntil - now)}`); }
  ab.textContent = lines.length ? lines.join(" ¬∑ ") : "Keine aktiven Boni.";
}
setInterval(()=>{
  if(Date.now() > questsState.buffs.scoreUntil && questsState.buffs.scoreMult !== 1){ questsState.buffs.scoreMult = 1; saveQuests(); }
  if(Date.now() > questsState.buffs.moneyUntil && questsState.buffs.moneyPerTile !== 0){ questsState.buffs.moneyPerTile = 0; saveQuests(); }
}, 2000);

document.addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'btnQuests'){ const dlg=document.getElementById('dlgQuests'); if(dlg){ renderQuests(); dlg.showModal(); } }
});

/* ---------- Game ---------- */
/* ---------- Ultra Swipe Animation Helpers ---------- */
function __getStepPx(){
  const rs = getComputedStyle(document.documentElement);
  const ts = parseFloat(rs.getPropertyValue('--tile-size')) || 48;
  const gg = parseFloat(rs.getPropertyValue('--grid-gap')) || 6;
  return ts + gg;
}

async function ultraAnimateSwap(i1,i2,isValid){
  const [r1,c1]=rcFromIndex(i1), [r2,c2]=rcFromIndex(i2);
  const dx = (c2 - c1), dy = (r2 - r1);
  const step = __getStepPx();
  const a = tileEls[i1], b = tileEls[i2];
  if(!a || !b) return;
  const durFwd = 140, durBack = 140;
  a.style.willChange = b.style.willChange = 'transform';
  a.style.transition = b.style.transition = `transform ${durFwd}ms cubic-bezier(.2,.8,.2,1)`;
  a.style.transform = `translate(${dx*step}px, ${dy*step}px)`;
  b.style.transform = `translate(${-dx*step}px, ${-dy*step}px)`;
  await sleep(durFwd + 10);
  if(isValid){
    // After reaching target visually, commit the logical swap,
    // then ease both tiles back to their cell (with swapped content).
    swap(i1,i2);
    a.style.transition = b.style.transition = `transform ${durBack}ms cubic-bezier(.2,.8,.2,1)`;
    a.style.transform = ``;
    b.style.transform = ``;
    await sleep(durBack + 20);
  } else {
    // Invalid: simply slide back.
    a.style.transition = b.style.transition = `transform ${durBack}ms cubic-bezier(.2,.8,.2,1)`;
    a.style.transform = ``;
    b.style.transform = ``;
    await sleep(durBack + 20);
  }
  a.style.transition = b.style.transition = ``;
  a.style.willChange = b.style.willChange = ``;
}


/* ---------- Score Milestones (10k => +5000‚Ç¨ to Kontostand) ---------- */
function handleScoreMilestones(prev, curr){
  const prevStep = Math.floor(prev / 10000);
  const currStep = Math.floor(curr / 10000);
  const crossed = currStep - prevStep;
  if(crossed > 0){
    const bonus = 5000 * crossed;
    points += bonus;
    updatePoints();
    try{
      showToast(`Bonus: +${bonus}‚Ç¨ zum Kontostand (${crossed}√ó 10k erreicht)` , 1800);
    }catch{ /* toast optional */ }
  }
}

const DEFAULT_EMOJIS = ["üê∂","üê±","üê∑","üêπ","üê∞","ü¶ä","üêª","üêº"];
let customEmojis=[...DEFAULT_EMOJIS];
let ownedEmojis=[];
let grid=[], tileEls=[], score=0, bestScore=0, points=0, threeLines=0; questOnScoreChanged(score);
let counts={refresh:1, rocket:0, bomb:0, destroy:0};
let activePower=null;

const boardEl = $("#board");
const scoreEl = $("#score");
const pointsEl = $("#points");
const cntRefresh = $("#cntRefresh");
const cntRocket = $("#cntRocket");
const cntBomb = $("#cntBomb");
const cntDestroy = $("#cntDestroy");
function randEmoji(){ return customEmojis[Math.floor(Math.random()*customEmojis.length)]; }
function initGrid(){
  grid = new Array(64).fill(null).map(()=>randEmoji());
  let guard=0; while(findMatches().length>0 && guard++<50){ grid = grid.map(()=>randEmoji()); }
  renderGrid();
  counts = {refresh:1, rocket:0, bomb:0, destroy:0};
  threeLines=0; activePower=null; updateCounts();
}

function renderGrid(){
  boardEl.innerHTML=""; tileEls=[];
  for(let i=0;i<64;i++){
    const el=document.createElement('div');
    el.className='tile';
    el.dataset.i=i;
    el.textContent = grid[i] || ' ';
    boardEl.appendChild(el);
    tileEls[i]=el;
  }
  bindTiles();
  try{ if(window.applyTilePalette) applyTilePalette(); }catch(e){}
}

const indexRC=(r,c)=>r*8+c;
const rcFromIndex=i=>[Math.floor(i/8), i%8];
function swap(i1,i2,tentative=false){ const t=grid[i1]; grid[i1]=grid[i2]; grid[i2]=t; if(!tentative){ tileEls[i1].textContent=grid[i1]; tileEls[i2].textContent=grid[i2]; } }
function findMatches(){
  const m=[];
  for(let r=0;r<8;r++){ let run=1; for(let c=1;c<8;c++){ const i=indexRC(r,c), p=indexRC(r,c-1); if(grid[i]===grid[p]) run++; else { if(run>=3) m.push({dir:'h', r, c0:c-run, len:run}); run=1; } } if(run>=3) m.push({dir:'h', r, c0:8-run, len:run}); }
  for(let c=0;c<8;c++){ let run=1; for(let r=1;r<8;r++){ const i=indexRC(r,c), p=indexRC(r-1,c); if(grid[i]===grid[p]) run++; else { if(run>=3) m.push({dir:'v', c, r0:r-run, len:run}); run=1; } } if(run>=3) m.push({dir:'v', c, r0:8-run, len:run}); }
  return m;
}
function canSwap(i1,i2){
  const [r1,c1]=rcFromIndex(i1), [r2,c2]=rcFromIndex(i2);
  if(Math.abs(r1-r2)+Math.abs(c1-c2)!==1) return false;
  swap(i1,i2,true); const ok=findMatches().length>0; swap(i1,i2,true); return ok;
}
function collapseAndFill(){
  for(let c=0;c<8;c++){
    const col=[];
    for(let r=7;r>=0;r--){ const i=indexRC(r,c); if(grid[i]!=null) col.push(grid[i]); }
    while(col.length<8) col.push(null);
    for(let r=7,k=0;r>=0;r--,k++){ grid[indexRC(r,c)]=col[k]; }
    for(let r=0;r<8;r++){ const i=indexRC(r,c); if(grid[i]==null) grid[i]=randEmoji(); }
  }
  for(let i=0;i<64;i++){ tileEls[i].textContent=grid[i]; tileEls[i].classList.remove('matching'); }
}
function showPointsAt(index, amount){
  if(perfMode==="low") return; // Low zeigt nichts an
  const el = tileEls[index]; const rect=el.getBoundingClientRect();
  const span = document.createElement('div');
  span.className='float'; span.textContent='+'+amount;
  span.style.left = (rect.left + rect.width/2 - 10) + 'px';
  span.style.top  = (rect.top - 4) + 'px';
  span.style.opacity='1';
  document.body.appendChild(span);
  let y=0, alpha=1;
  const tick=()=>{
    y -= 1.5; alpha -= 0.03;
    span.style.transform=`translateY(${y}px)`; span.style.opacity=String(alpha);
    if(alpha<=0){ span.remove(); } else requestAnimationFrame(tick);
  };
  requestAnimationFrame(tick);
}
async function resolveMatches(){
  const matches=findMatches(); if(!matches.length) return false; questTrackMatches(matches);
  const toClear=new Set(); let threeNow=0;
  for(const m of matches){
    if(m.dir==='h'){ for(let c=0;c<m.len;c++) toClear.add(indexRC(m.r,m.c0+c)); }
    else { for(let r=0;r<m.len;r++) toClear.add(indexRC(m.r0+r,m.c)); }
    if(m.len===4){ counts.rocket++; points+=100; AudioSys.sfx4(); }
    if(m.len>=5){ counts.bomb++; points+=100; AudioSys.sfx5(); }
    if(m.len===3){ threeNow++; AudioSys.sfx3(); }
  }
  threeLines += threeNow; while(threeLines>=15){ counts.destroy++; points+=100; threeLines-=15; }
  updateCounts(); updatePoints();

  const gained = toClear.size * getScorePerTile(); const _prevScore1 = score; score += gained; questOnScoreChanged(score); const moneyGain = toClear.size * getMoneyPerTile(); if(moneyGain>0){ points += moneyGain; updatePoints(); } questOnScoreChanged(score); scoreEl.textContent = "Score: " + score; handleScoreMilestones(_prevScore1, score);
  if(score>bestScore){ bestScore=score; const ab=document.getElementById('accBest'); if(ab) ab.textContent=bestScore; saveBest(); }
  if(perfMode!=="low"){ const first = toClear.values().next().value; if(first!=null) showPointsAt(first, gained); }
  toClear.forEach(i=> tileEls[i].classList.add('matching'));
  await sleep( perfMode==="low" ? 0 : 280 );
  toClear.forEach(i=> grid[i]=null);
  collapseAndFill();
  await resolveMatches();
  try{ saveGameCloud(true); }catch(_){ }

}

/* input / gestures ‚Äî unified Pointer Events with debounce */
let touchStartIndex=null, swipeBusy=false;
function bindTiles(){
  tileEls.forEach(el=>{
    el.onpointerdown = e=>{
      el.setPointerCapture(e.pointerId);
      el._sx=e.clientX; el._sy=e.clientY; el._idx=Number(el.dataset.i);
      if(!window._audioInit){ AudioSys.init(); window._audioInit=true; }
    };
    el.onpointerup = async e=>{
      const i=el._idx; el.releasePointerCapture(e.pointerId); el._idx=null;
      if(i==null || swipeBusy) return;
      swipeBusy=true;
      try{
        const dx=e.clientX-el._sx, dy=e.clientY-el._sy;
        await handleSwipe(i,dx,dy);
      } finally {
        setTimeout(()=>{ swipeBusy=false; }, 100);
      }
    };
    el.ontouchstart = el.ontouchend = el.onmousedown = null;
  });
}
async function handleSwipe(i,dx,dy){
  if(activePower){
    if(activePower==='refresh'){
      if(counts.refresh>0){
        counts.refresh --; updateCounts();
        shuffleBoard();
      }
      setActivePower(null); return;
    }
    if(activePower==='rocket'){ const orient=Math.abs(dx)>Math.abs(dy)?'h':'v'; await useRocket(i,orient); setActivePower(null); return; }
    if(activePower==='bomb'){ await useBomb(i); setActivePower(null); return; }
    if(activePower==='destroy'){ await useDestroy(grid[i]); setActivePower(null); return; }
  } else {
    const dir=Math.abs(dx)>Math.abs(dy)?(dx>0?'right':'left'):(dy>0?'down':'up');
    const [r,c]=rcFromIndex(i); let j=null;
    if(dir==='right'&&c<7) j=indexRC(r,c+1);
    if(dir==='left'&&c>0) j=indexRC(r,c-1);
    if(dir==='down'&&r<7) j=indexRC(r+1,c);
    if(dir==='up'&&r>0) j=indexRC(r-1,c);
    if(j==null) return;
    
if(perfMode==="ultra"){
  const valid = canSwap(i,j);
  if(!valid){
    await ultraAnimateSwap(i,j,false);
    AudioSys.sfxBad();
    return;
  }
  await ultraAnimateSwap(i,j,true);
  await sleep(60);
  await resolveMatches();
  return;
}
if(!canSwap(i,j)){
  if(perfMode!=="low"){
    tileEls[i].style.transform = `translate(${Math.sign(dx)*10}px, ${Math.sign(dy)*10}px)`;
    setTimeout(()=> tileEls[i].style.transform="", 140);
  }
  AudioSys.sfxBad();
  return;
}
swap(i,j); await sleep( perfMode==="low" ? 0 : 80 ); await resolveMatches();
}
}
function shuffleBoard(){
  function r(){ return customEmojis[Math.floor(Math.random()*customEmojis.length)]; }
  let ng = new Array(64).fill(null).map(()=>r());
  let guard=0; // avoid start matches
  while(true){
    // check matches
    let ok=true;
    for(let r0=0;r0<8;r0++){
      for(let c0=0;c0<8;c0++){
        const i=indexRC(r0,c0);
        if(c0>=2 && ng[i]===ng[indexRC(r0,c0-1)] && ng[i]===ng[indexRC(r0,c0-2)]) ok=false;
        if(r0>=2 && ng[i]===ng[indexRC(r0-1,c0)] && ng[i]===ng[indexRC(r0-2,c0)]) ok=false;
      }
    }
    if(ok || guard++>60) break; else ng=ng.map(()=>r());
  }
  grid=ng; for(let i=0;i<64;i++){ tileEls[i].textContent=grid[i]; tileEls[i].classList.remove('matching'); }
}
function updateCounts(){ cntRefresh.textContent=counts.refresh; cntRocket.textContent=counts.rocket; cntBomb.textContent=counts.bomb; cntDestroy.textContent=counts.destroy; }
function updatePoints(){ pointsEl.textContent="Punkte: "+points; if(user && db){ fb.setDoc(fb.doc(db,"users",user.name), {points}, {merge:true}); } }


/* power-up buttons */
const powerEls = {
  refresh: $("#pupRefresh"),
  rocket:  $("#pupRocket"),
  bomb:    $("#pupBomb"),
  destroy: $("#pupDestroy")
};

function setActivePower(name){
  if(name && counts && counts[name] !== undefined && counts[name] <= 0){
    return; // cannot select empty
  }
  activePower = (activePower === name ? null : name);
  for(const [key, el] of Object.entries(powerEls)){
    const on = (activePower === key);
    el.classList.toggle('selected', on);
    el.setAttribute('aria-pressed', on ? 'true' : 'false');
  }
}

powerEls.refresh.onclick = ()=> setActivePower('refresh');
powerEls.rocket.onclick  = ()=> setActivePower('rocket');
powerEls.bomb.onclick    = ()=> setActivePower('bomb');
powerEls.destroy.onclick = ()=> setActivePower('destroy');

/* keep selection consistent when counts change */
const _updateCounts_old = typeof updateCounts === 'function' ? updateCounts : null;
updateCounts = function(){
  if(_updateCounts_old) _updateCounts_old();
  // if selected powerup ran out, deselect
  if(activePower && counts[activePower] <= 0){
    setActivePower(null);
  }
};
/* header/footer buttons */
$("#btnInfo").onclick=()=> document.getElementById('dlgInfo').showModal();
$("#btnAccount").onclick=()=> openAccount();
$("#btnRestart").onclick=()=>{ if(confirm("Spiel wirklich neu starten?")){ initGrid(); questOnScoreChanged(score); score=0; scoreEl.textContent="Score: 0"; } };
$("#btnPerf").onclick=()=>{
  const next = {low:"mid",mid:"high",high:"ultra",ultra:"low"}[perfMode];
  if(next==="ultra"){
    if(!confirm("Ultra-Modus aktivieren? Dies nutzt mehr Leistung. Nein = Niedrig.")){ setPerf("low"); return; }
  }
  setPerf(next);
};
$("#btnTop").onclick=()=> openTop();


/* ---------- Firebase Auth (for Leaderboard rules Variant 1) ---------- */
let auth=null;
try{
  if(typeof fb !== "undefined" && typeof fb.getAuth === "function"){
    auth = fb.getAuth();
    try{
      if(!auth.currentUser){
        fb.onAuthStateChanged(auth, (u)=>{});
        fb.signInAnonymously(auth).catch(()=>{});
      }
    }catch(e){}
  }
}catch(e){}

/* ---------- Account / Shop / Customization ---------- */
let user=null, selectedTrophy=null;
  try{ saveGameCloud(true); }catch(_){ }
const SHOP_EMOJIS = Array.from(new Set([
  ..."üçéüçäüçãüçåüçâüçáüçìü´êüçíüçëü•ùüççü••ü•ëüå∂Ô∏èü•ïüç†ü•îü•¶ü•¨ü•íüßÖüçÑüåΩüçûü•êü•®üßÄüçñüçóü•©ü•ìüçîüçüüå≠üçïü•™üåÆüåØü•ôüçúüçùüç£üç§üç±ü•üüç∞üßÅüç™üç©üç´üç¨üç≠üçÆüçØüç∫üçªüç∑üç∏üçπü•§üßã‚òïü´ñ"
  + "‚öΩüèÄüèà‚öæüéæüèêüèâüé±üèìüè∏ü•Öü•äüéÆüïπÔ∏èüé≤üéØ‚ôüÔ∏èüß©"
  + "üöóüöïüöôüõªüöêüöåüöéüèéÔ∏èüöìüöëüöíüööüöõüöú‚úàÔ∏èüöÄüõ∏‚õµüö§üõ∂üõ•Ô∏èüöÅ"
  + "üå≤üå≥üå¥üåµüå∫üå∏üåºüåªüå∑üåπüåæüçÅüçÇüçÉüåçüåéüåèüåô‚≠ê‚òÄÔ∏è‚õÖüåßÔ∏èüå©Ô∏è‚ùÑÔ∏èüåà"
  + "üòÄüòÑüòÅüòÜüòÖüòÇüôÇüòâüòäüòçüòòüòúü§ìü§©ü•≥üòéü§ñüëªüí©üëëüíéüß∏"
].values()));
function trophiesFromPoints(p){
  const t=[]; if(p>=10000) t.push("ü•â"); if(p>=40000) t.push("ü•à"); if(p>=70000) t.push("ü•á"); if(p>=100000) t.push("üèÖ"); if(p>=150000) t.push("üéñ"); if(p>=200000) t.push("üèÜ"); return t;
}
async function openAccount(){
  const dlg = document.getElementById('dlgAccount'); dlg.showModal();
  if(!user){ $("#accNotLogged").style.display="block"; $("#accLogged").style.display="none"; $("#chipUser").textContent="Abgemeldet"; return; }
  $("#accNotLogged").style.display="none"; $("#accLogged").style.display="block";
  $("#chipUser").textContent=user.name; $("#accName").textContent=user.name; $("#accPoints").textContent=points; $("#accBest").textContent=bestScore;
  renderTrophies();
}
async function fbReady(timeout=12000){
  const start=performance.now(); while(!db && performance.now()-start<timeout){ await sleep(100); } return !!db;
}


document.getElementById('btnLogin').onclick = async ()=>{
  const name=$("#inpUser").value.trim(), pass=$("#inpPass").value;
  if(!name||!pass) return alert("Bitte Name & Passwort.");
  try{
    if(await fbReady()){
      const d = await fb.getDoc( fb.doc(db,"users",name) );
      if(!d.exists()) return alert("Kein Konto gefunden.");
      const data=d.data(); if(data.pass !== hash(pass)) return alert("Passwort falsch.");
      user = {name}; points=data.points||0; bestScore=data.bestScore||0; selectedTrophy=data.selectedTrophy||null;
      ownedEmojis=data.ownedEmojis||[]; customEmojis=data.customEmojis||DEFAULT_EMOJIS.slice();
      setPerf(data.perfMode||perfMode);
    
      // Restore save if present
      if(data.save){ restoreSave(data.save); }
      else { try{ const ls = localStorage.getItem('__em_save_'+name); if(ls){ restoreSave(JSON.parse(ls)); } }catch(_){ } }
} else {
      // Lokaler Fallback (offline)
      const users=localUsers(); if(!users[name]) return alert("Kein Konto (lokal) gefunden.");
      if(users[name].pass!==hash(pass)) return alert("Passwort falsch.");
      user={name}; ({points=0,bestScore=0,selectedTrophy=null,ownedEmojis=[],customEmojis=DEFAULT_EMOJIS} = users[name]);
    }
    openAccount();
  }catch(e){
    if(e && e.code === "permission-denied"){
      alert("Login fehlgeschlagen: Firestore-Regeln blocken den Zugriff (permission-denied). Aktiviere Anonymous Auth oder passe die Regeln an.");
    }else{
      alert("Login-Fehler: " + (e && (e.message||e) || "Unbekannt"));
    }
  }
};
document.getElementById('btnSignup').onclick = async ()=>{
  const name=$("#inpUser").value.trim(), pass=$("#inpPass").value;
  if(!name||!pass) return alert("Bitte Name & Passwort.");
  try{
    if(await fbReady()){
      const exists = await fb.getDoc( fb.doc(db,"users",name) );
      if(exists.exists()) return alert("Name bereits vergeben.");
      user={name}; points=0; bestScore=0; selectedTrophy=null; ownedEmojis=[]; customEmojis=DEFAULT_EMOJIS.slice();
      await fb.setDoc(
        fb.doc(db,"users",name),
        { pass:hash(pass), points, bestScore, selectedTrophy, ownedEmojis, customEmojis, perfMode, createdAt: fb.serverTimestamp() }
      );
    } else {
      const users=localUsers(); if(users[name]) return alert("Name bereits vergeben (lokal).");
      users[name] = {pass:hash(pass), points:0, bestScore:0, selectedTrophy:null, ownedEmojis:[], customEmojis:DEFAULT_EMOJIS.slice(), perfMode};
      saveLocalUsers(users);
      user={name}; points=0; bestScore=0; selectedTrophy=null; ownedEmojis=[]; customEmojis=DEFAULT_EMOJIS.slice();
    }
    openAccount();
  }catch(e){
    if(e && e.code === "permission-denied"){
      alert("Registrierung fehlgeschlagen: Firestore-Regeln blocken den Zugriff (permission-denied). Aktiviere Anonymous Auth oder passe die Regeln an.");
    }else{
      alert("Signup-Fehler: " + (e && (e.message||e) || "Unbekannt"));
    }
  }
};
document.getElementById('btnRename').onclick = async ()=>{
  if(!user) return; if(points < 20000) return alert("Nicht genug Punkte.");
  const newName = prompt("Neuer Name:"); if(!newName) return;
  if(await fbReady()){
    const exists = await fb.getDoc(fb.doc(db,"users",newName)); if(exists.exists()) return alert("Name belegt.");
    const old = (await fb.getDoc(fb.doc(db,"users",user.name))).data();
    await fb.setDoc(fb.doc(db,"users",newName), old);
    await fb.setDoc(fb.doc(db,"users",user.name), {renamedTo:newName}, {merge:true});
  } else {
    const users=localUsers(); if(users[newName]) return alert("Name belegt (lokal).");
    users[newName]=users[user.name]; delete users[user.name]; saveLocalUsers(users);
  }
  user.name=newName; points-=20000; $("#accPoints").textContent=points;
};
document.getElementById('btnMusic').onclick = ()=>{
  const btn=$("#btnMusic"); const on = btn.textContent!=="AN"; btn.textContent = on?"AN":"AUS"; AudioSys.setMusic(on); localStorage.setItem("music", on?"1":"0");
};
document.getElementById('btnSound').onclick = ()=>{
  const btn=$("#btnSound"); const on = btn.textContent!=="AN"; btn.textContent = on?"AN":"AUS"; AudioSys.setSfx(on); localStorage.setItem("sfx", on?"1":"0");
};
/* removed legacy btnPlayYT onclick (fixed) */

function renderTrophies(){
  const t = trophiesFromPoints(points);
  const box = document.getElementById('trophyList'); box.innerHTML="";
  t.forEach(em=>{
    const row=document.createElement('div'); row.className="row";
    row.innerHTML = `<div style="font-size:1.3rem">${em}</div><div><button class="btn small ${selectedTrophy===em?'primary':''}">Ausw√§hlen</button></div>`;
    const btn=row.querySelector('button'); btn.onclick=async()=>{
      selectedTrophy=em;
      if(db && user) await fb.setDoc(fb.doc(db,"users",user.name), {selectedTrophy:em}, {merge:true});
      renderTrophies();
    };
    box.appendChild(row);
  });
}

/* Shop / Customize */
document.getElementById('btnShop').onclick = ()=>{ document.getElementById('dlgShop').showModal(); renderShop(); };
document.getElementById('shopSearch').addEventListener('input', (e)=> renderShop(e.target.value.trim()));
function renderShop(filter=""){
  const grid = document.getElementById('shopGrid'); grid.innerHTML="";
  const owned = new Set(ownedEmojis);
  const list = SHOP_EMOJIS.filter(e=> !DEFAULT_EMOJIS.includes(e) && (!filter || e.includes(filter))).slice(0,200);
  list.forEach(em=>{
    const btn=document.createElement('button'); btn.className="btn"; btn.style.fontSize="1.4rem"; btn.textContent=em;
    if(owned.has(em)){ btn.disabled=true; btn.textContent=em+" ‚úì"; } else { btn.title="10.000 Punkte"; }
    btn.onclick=async()=>{
      if(points < 10000) return alert("Nicht genug Punkte.");
      ownedEmojis.push
  try{ saveGameCloud(true); }catch(_){ }(em); points-=10000; updatePoints();
      if(db&&user) await fb.setDoc(fb.doc(db,"users",user.name), {ownedEmojis, points}, {merge:true});
      else { const users=localUsers(); users[user.name].ownedEmojis=ownedEmojis; users[user.name].points=points; saveLocalUsers(users); }
      renderShop(filter);
    };
    grid.appendChild(btn);
  });
}
document.getElementById('btnCustomize').onclick = ()=>{ document.getElementById('dlgCustom').showModal(); renderCustomize(); };
function renderCustomize(){
  const box = document.getElementById('customGrid'); box.innerHTML="";
  const pool = DEFAULT_EMOJIS.concat(ownedEmojis);
  let sel = new Set(customEmojis);
  pool.forEach(em=>{
    const btn=document.createElement('button'); btn.className="btn"; btn.style.fontSize="1.4rem"; btn.textContent=em; btn.classList.toggle('primary', sel.has(em));
    btn.onclick=()=>{ if(sel.has(em)){ sel.delete(em); } else if(sel.size<8){ sel.add(em); } btn.classList.toggle('primary', sel.has(em)); };
    box.appendChild(btn);
  });
  document.getElementById('btnSaveCustom').onclick = async ()=>{
    if(sel.size!==8) return alert("Bitte genau 8 Emojis ausw√§hlen.");
    customEmojis = Array.from(sel);
    if(db&&user) await fb.setDoc(fb.doc(db,"users",user.name), {customEmojis}, {merge:true});
    else { const users=localUsers(); users[user.name].customEmojis=customEmojis; saveLocalUsers(users); }
    document.getElementById('dlgCustom').close(); initGrid();
  };
}

/* ---------- Leaderboard ---------- */

async function saveBest(){
  if(user && db){
    try{
      if(typeof auth !== "undefined" && auth && !auth.currentUser && typeof fb.signInAnonymously === "function"){
        try{ await fb.signInAnonymously(auth); }catch(e){}
      }
      const uid = (auth && auth.currentUser) ? auth.currentUser.uid : null;
      const ref = fb.doc(db,"leaderboard", user.name);
      await fb.runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists()){
          tx.set(ref, {
            displayName: user.name,
            bestScore: bestScore,
            updatedAt: fb.serverTimestamp(),
            ownerUid: uid || "anon"
          });
          return;
        }
        const cur = snap.data();
        if(bestScore > (cur.bestScore || 0)){
          tx.update(ref, {
            bestScore: bestScore,
            updatedAt: fb.serverTimestamp(),
            ownerUid: (cur.ownerUid || uid || "anon"),
            displayName: user.name
          });
        } else {
          tx.update(ref, { updatedAt: fb.serverTimestamp(), displayName: user.name });
        }
      });
    }catch(err){
      console.warn("Leaderboard update failed:", err);
    }
  }
}

async function openTop(){
  const dlg=document.getElementById('dlgTop'); dlg.showModal();
  const list=document.getElementById('topList'); list.innerHTML="";
  if(db){
    const q = fb.query(fb.collection(db,"leaderboard"), fb.orderBy("bestScore","desc"), fb.limit(10));
    if(window.__topUnsub) { try{ window.__topUnsub(); }catch(e){} }
    window.__topUnsub = fb.onSnapshot(q, (topSnap)=>{
      list.innerHTML = "";
      let rank=1, inTop=false;
      topSnap.forEach(s=>{
        const d=s.data();
        const row=document.createElement('div'); row.className='row';
        const name = d.displayName || s.id || "Player";
        const val = d.bestScore || 0;
        row.innerHTML = `<div><b>${rank}.</b> ${name}</div><div><b>${val}</b></div>`;
        list.appendChild(row);
        if(user && (name===user.name)) inTop=true;
        rank++;
      });
      if(user && !inTop){
        (async()=>{
          try{
            const q2 = fb.query(fb.collection(db,"leaderboard"), fb.where("bestScore", ">", bestScore));
            const s2 = await fb.getDocs(q2);
            const row=document.createElement('div'); row.className='row you';
            row.innerHTML = `<div><b>${s2.size+1}.</b> ${user.name}</div><div><b>${bestScore}</b></div>`;
            list.appendChild(row);
          }catch(e){ /* ignore */ }
        })();
      }
    });
  } else {
    const users=localUsers();
    const arr=Object.entries(users).map(([name,d])=>({user:name,score:(d.bestScore||0)})).sort((a,b)=>b.score-a.score);
    arr.slice(0,10).forEach((d,i)=>{
      const row=document.createElement('div'); row.className='row';
      row.innerHTML = `<div><b>${i+1}.</b> ${d.user}</div><div><b>${d.score}</b></div>`;
      list.appendChild(row);
    });
    if(user){
      const over = arr.filter(x=>x.score>bestScore).length;
      const row=document.createElement('div'); row.className='row you';
      row.innerHTML = `<div><b>${over+1}.</b> ${user.name}</div><div><b>${bestScore}</b></div>`;
      list.appendChild(row);
    }
  }

}

/* ---------- Power-up effects ---------- */
async function useRocket(i,orient){
  if(counts.rocket<=0) return;
  counts.rocket--; updateCounts(); points+=100; updatePoints(); AudioSys.sfxRocket();
  const [r,c]=rcFromIndex(i);
  let cleared=0;
  if(orient==='h'){ for(let cc=0;cc<8;cc++){ const idx=indexRC(r,cc); tileEls[idx].classList.add('matching'); grid[idx]=null; cleared++; } }
  else{ for(let rr=0;rr<8;rr++){ const idx=indexRC(rr,c); tileEls[idx].classList.add('matching'); grid[idx]=null; cleared++; } }
  await sleep( perfMode==="low"||perfMode==="mid" ? 0 : 260 );
  collapseAndFill(); const _prevScore2 = score; questOnScoreChanged(score); score += cleared*10; scoreEl.textContent="Score: "+score; handleScoreMilestones(_prevScore2, score);
  try{ saveGameCloud(true); }catch(_){ }

  try{ setActivePower(null); }catch(_){ }

}
async function useBomb(i){
  if(counts.bomb<=0) return;
  counts.bomb--; updateCounts(); points+=100; updatePoints(); AudioSys.sfxBomb();
  const [r0,c0]=rcFromIndex(i); const tiles=[]; for(let dr=-2;dr<=2;dr++) for(let dc=-2;dc<=2;dc++){ const r=r0+dr,c=c0+dc; if(r>=0&&r<8&&c>=0&&c<8) tiles.push(indexRC(r,c)); }
  tiles.forEach(idx=> tileEls[idx].classList.add('matching')); await sleep(perfMode==="low"||perfMode==="mid"?0:260);
  tiles.forEach(idx=> grid[idx]=null); questOnScoreChanged(score); collapseAndFill(); const _prevScore3 = score; score += tiles.length*10; scoreEl.textContent="Score: "+score; handleScoreMilestones(_prevScore3, score);
  try{ saveGameCloud(true); }catch(_){ }

  try{ setActivePower(null); }catch(_){ }

}
async function useDestroy(emoji){
  if(counts.destroy<=0) return;
  counts.destroy--; updateCounts(); points+=100; updatePoints();
  const idxs=grid.map((v,idx)=> v===emoji?idx:-1).filter(x=>x>=0); idxs.forEach(idx=> tileEls[idx].classList.add('matching'));
  await sleep(perfMode==="low"||perfMode==="mid"?0:260);
  idxs.forEach(idx=> grid[idx]=null); questOnScoreChanged(score); collapseAndFill(); const _prevScore4 = score; score += idxs.length*10; scoreEl.textContent="Score: "+score; handleScoreMilestones(_prevScore4, score);
  try{ saveGameCloud(true); }catch(_){ }

  try{ setActivePower(null); }catch(_){ }

}


/* ---------- Admin (Ctrl+Alt+#) ---------- */
const ADMIN_KEY = "140318";
let adminUnsub = null;
let lastAdminDocs = [];
function openAdminLogin(){
  const d = document.getElementById('dlgAdminLogin');
  const inp = document.getElementById('admPass');
  const msg = document.getElementById('admMsg');
  msg.textContent = "";
  inp.value = "";
  d.showModal();
  setTimeout(()=> inp.focus(), 50);
}
function openAdminPanel(){
  const dlg = document.getElementById('dlgAdmin');
  const list = document.getElementById('adminList');
  const stats = document.getElementById('adminStats');
  const search = document.getElementById('adminSearch');
  dlg.showModal();
  // Live query: all users ordered by bestScore desc then name asc
  if(adminUnsub){ try{ adminUnsub(); }catch{} adminUnsub=null; }
  if(db){
    const q = fb.query(fb.collection(db,"users"));
    adminUnsub = fb.onSnapshot(q, (snap)=>{
      lastAdminDocs = snap.docs.map(d=> ({id:d.id, ...d.data()}));
      renderAdminList();
    }, (e)=>{
      stats.textContent = "Fehler beim Laden: " + (e && e.message || e);
    });
    stats.textContent = "Verbunden mit Firestore ‚Ä¶";
  } else {
    // offline fallback: local users
    const users = localUsers();
    lastAdminDocs = Object.keys(users).map(name=> ({id:name, ...users[name]}));
    renderAdminList();
    stats.textContent = "Offline-Modus (lokale Nutzer)";
  }
  search.oninput = renderAdminList;
  dlg.addEventListener('close', ()=>{ if(adminUnsub){ try{ adminUnsub(); }catch{} adminUnsub=null; } }, {once:true});
}
function renderAdminList(){
  const list = document.getElementById('adminList');
  const stats = document.getElementById('adminStats');
  const term = (document.getElementById('adminSearch').value||"").toLowerCase();
  const data = lastAdminDocs
    .filter(d=> !term || (d.id && d.id.toLowerCase().includes(term)))
    .sort((a,b)=> (b.bestScore||0)-(a.bestScore||0) || String(a.id).localeCompare(String(b.id)));
  stats.textContent = `${data.length} Spieler angezeigt`;
  if(!data.length){ list.innerHTML = '<div class="adm-empty">Keine Spieler gefunden.</div>'; return; }
  const rows = data.slice(0,500).map(d=>{
    const name = d.id; questOnScoreChanged(score);
    const score = d.bestScore || 0;
    const pts = d.points || 0;
    const trophy = d.selectedTrophy || "";
    return `<div class="adm-row" data-name="${name}">
      <div>${trophy} <b>${name}</b></div>
      <div><input type="number" class="adm-score" value="${score}" min="0" step="10" /></div>
      <div><input type="number" class="adm-points" value="${pts}" min="0" step="100" /></div>
      <div class="adm-actions">
        <button class="btn small primary adm-save">Speichern</button>
      </div>
    </div>`;
  }).join("");
  list.innerHTML = rows;
  // bind save buttons
  list.querySelectorAll('.adm-row').forEach(row=>{
    const name = row.getAttribute('data-name');
    const scoreInp = row.querySelector('.adm-score');
    const ptsInp = row.querySelector('.adm-points');
    const saveBtn = row.querySelector('.adm-save');
    async function doSave(){
      const newScore = Math.max(0, parseInt(scoreInp.value||"0",10));
      const newPts = Math.max(0, parseInt(ptsInp.value||"0",10));
      saveAdminChanges(name, newScore, newPts, row, saveBtn);
    }
    saveBtn.onclick = doSave;
    // Autosave on Enter
    [scoreInp, ptsInp].forEach(inp=> inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ doSave(); } }));
    // Optional: save on blur
    [scoreInp, ptsInp].forEach(inp=> inp.addEventListener('blur', ()=>{ /* uncomment to autosave on blur */ }));
  });
}
async function saveAdminChanges(name, bestScoreValue, pointsValue, row, btn){
  try{
    btn.disabled = true;
    btn.textContent = "Speichert‚Ä¶";
    if(db){
      // Update user doc
      await fb.setDoc(fb.doc(db,"users",name), {bestScore: bestScoreValue, points: pointsValue}, {merge:true});
      // Update leaderboard doc to reflect the new score
      await fb.setDoc(fb.doc(db,"leaderboard",name), { user:name, score: bestScoreValue, updatedAt: fb.serverTimestamp() }, {merge:true});
    } else {
      const users = localUsers();
      if(!users[name]) users[name] = {pass:"", points:0, bestScore:0};
      users[name].bestScore = bestScoreValue;
      users[name].points = pointsValue;
      saveLocalUsers(users);
    }
    btn.textContent = "Gespeichert ‚úì";
    setTimeout(()=>{ btn.textContent="Speichern"; btn.disabled=false; }, 900);
    showToast(`Admin-Update: ${name} ‚Äî Score ${bestScoreValue}, Punkte ${pointsValue}`, 1200);
    // If admin edited the currently logged-in user, update in-memory too
    if(user && user.name === name){
      points = pointsValue; updatePoints();
      bestScore = bestScoreValue; const ab=document.getElementById('accBest'); if(ab) ab.textContent=bestScore;
    }
  }catch(e){
    btn.disabled=false;
    btn.textContent = "Fehler";
    alert("Speichern fehlgeschlagen: " + (e && (e.message||e) || e));
  }
}
window.addEventListener('keydown', (e)=>{
  // ignore when typing in inputs or dialogs
  const active = document.activeElement;
  const isInput = active && (active.tagName==='INPUT' || active.tagName==='TEXTAREA' || active.isContentEditable);
  if(isInput) return;
  // Detect Ctrl+Alt+# (also allow Shift+3 on some layouts)
  const hit = (e.ctrlKey && e.altKey && (e.key === '#' || (e.key === '3' && e.shiftKey)));
  if(hit){
    e.preventDefault();
    // If session already verified, open directly
    if(sessionStorage.getItem('adminOK') === '1'){ openAdminPanel(); return; }
    openAdminLogin();
  }
});
document.getElementById('btnAdmCancel').onclick = ()=> document.getElementById('dlgAdminLogin').close();
document.getElementById('btnAdmLogin').onclick = ()=>{
  const val = (document.getElementById('admPass').value || '').trim();
  const msg = document.getElementById('admMsg');
  if(val === ADMIN_KEY){
    sessionStorage.setItem('adminOK','1');
    document.getElementById('dlgAdminLogin').close();
    openAdminPanel();
  } else {
    msg.textContent = "Falsches Passwort.";
  }
};



// ---- Cloud Save / Load ----
function getSavePayload(){
  try{
    return {
      grid: Array.isArray(grid) ? [...grid] : [],
      score: typeof score==='number' ? score : 0,
      points: typeof points==='number' ? points : 0,
      counts: (counts && typeof counts==='object') ? {refresh:counts.refresh||0, rocket:counts.rocket||0, bomb:counts.bomb||0, destroy:counts.destroy||0} : {refresh:1,rocket:0,bomb:0,destroy:0},
      selectedTrophy: selectedTrophy || null,
      customEmojis: Array.isArray(customEmojis) ? [...customEmojis] : [],
      ownedEmojis: Array.isArray(ownedEmojis) ? [...ownedEmojis] : [],
      perfMode
    };
  }catch(e){ return {}; }
}

async function saveGameCloud(auto=true){
  const payload = { save: getSavePayload() };
  try{
    if(db && user && user.name){
      await fb.updateDoc( fb.doc(db,"users", user.name), payload );
      if(!auto) console.log("Spielstand gespeichert.");
    } else {
      throw new Error("no-db-or-user");
    }
  }catch(e){
    try{
      localStorage.setItem("__em_save_"+(user && user.name ? user.name : "_local"), JSON.stringify(payload.save));
      if(!auto) console.warn("Cloud-Save fehlgeschlagen ‚Äì lokal gespeichert:", e && (e.message||e));
    }catch(_) {}
  }
}

function restoreSave(sv){
  try{
    if(!sv) return false;
    if(Array.isArray(sv.grid) && sv.grid.length===64){ grid = [...sv.grid]; }
    if(typeof sv.score==='number'){ score = sv.score; scoreEl.textContent = "Score: " + score; }
    if(typeof sv.points==='number'){ points = sv.points; updatePoints(); }
    if(sv.counts){ counts = { refresh:sv.counts.refresh||0, rocket:sv.counts.rocket||0, bomb:sv.counts.bomb||0, destroy:sv.counts.destroy||0 }; updateCounts(); }
    if(Array.isArray(sv.customEmojis) && sv.customEmojis.length){ customEmojis = [...sv.customEmojis]; }
    if(Array.isArray(sv.ownedEmojis)){ ownedEmojis = [...sv.ownedEmojis]; }
    if(sv.perfMode){ setPerf(sv.perfMode); }
    renderGrid();
    return true;
  }catch(e){ console.warn("Restore fehlgeschlagen:", e); return false; }
}

// Autosave alle 15s
if(!window.__saveTimer){
  window.__saveTimer = setInterval(()=>{ saveGameCloud(true); }, 15000);
}
// Save beim Tab-Schlie√üen (unsichtbar, notfalls lokal)
window.addEventListener('beforeunload', ()=>{ try{ /* noop */ }catch(_){ } });



// Manual save button
const _saveBtn = document.getElementById('btnSave');
if(_saveBtn){ _saveBtn.onclick = ()=>{ saveGameCloud(false); }; }



// Manual save button with feedback
(function(){
  const _saveBtn = document.getElementById('btnSave');
  if(!_saveBtn) return;
  _saveBtn.onclick = ()=>{
    (async()=>{
      try{
        const old = _saveBtn.textContent;
        _saveBtn.disabled = true;
        _saveBtn.textContent = "Speichern‚Ä¶";
        await saveGameCloud(false);
        _saveBtn.textContent = "Gespeichert";
        showToast("Gespeichert", true);
        setTimeout(()=>{ try{ _saveBtn.textContent = old; _saveBtn.disabled=false; }catch(_){ } }, 700);
      }catch(e){
        try{ _saveBtn.disabled=false; showToast("Fehler beim Speichern", false); }catch(_){ }
      }
    })();
  };
})();

/* ---------- Boot ---------- */
computeTileSize();
setPerf(perfMode);
initGrid();

// Apply saved audio toggles
if(localStorage.getItem("music")==="1"){ $("#btnMusic").textContent="AN"; AudioSys.setMusic(true); }
if(localStorage.getItem("sfx")!=="0"){ $("#btnSound").textContent="AN"; AudioSys.setSfx(true); } else { AudioSys.setSfx(false); }
</script>

  <!-- === Design Modal (isolated) === -->
  <style>
    #designModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50000; }
    #designShade{ position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(2px); }
    #designCard{
      position:relative; z-index:1; width:min(860px, 96vw); max-height:90vh; overflow:auto;
      background:#1c1430; border:1px solid #3a2c63; border-radius:16px; padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
      color:#e8e6ff;
    }
    #designCard h2{ margin:.25rem 0 .5rem 0; font-size:1.1rem; }
    #designCard .section{ border:1px solid #3a2c63; border-radius:12px; padding:12px; margin:10px 0; background:#23183d; }
    #designCard .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:.35rem 0; }
    #designCard label{ min-width:14rem; }
    #designClose{ position:absolute; top:10px; right:10px; }
    #yt-live-bg{ position:absolute; inset:0; z-index:0; overflow:hidden; pointer-events:none; }
    #yt-live-bg iframe{ width:120vw; height:120vh; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
  
/* Tile palette editor */
#dlgTilePalette .grid-tiles{
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 6px;
  margin-top: 8px;
}
#dlgTilePalette .grid-tiles input[type="color"]{
  width: 34px; height: 34px; padding: 0; border: none; outline: none;
  background: none; border-radius: 6px; cursor: pointer;
}
#dlgTilePalette footer{
  display: flex; gap: 8px; justify-content: flex-end; margin-top: 10px;
}
</style>

/* --- OFFICIAL v15: Force scroll for 'Hintergr√ºnde anpassen' modal --- */
#designModal { align-items: flex-start !important; padding-top: 12px !important; }
#designCard {
  max-height: calc(100dvh - 20px) !important;
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch !important;
  overscroll-behavior: contain !important;
  touch-action: pan-y !important;
  padding-bottom: calc(220px + var(--safe-bottom, 0px)) !important;
  display: block !important;
}
#designCard * { -webkit-overflow-scrolling: touch !important; }
@media (max-width: 768px), (pointer: coarse) {
  #designCard { width: 96vw !important; max-height: calc(100dvh - 16px) !important; }
}


/* --- OFFICIAL v14: Design-Modal deep mobile scroll --- */
#designCard{
  max-height: calc(100dvh - 32px) !important;
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch !important;
  overscroll-behavior: contain !important;
  touch-action: pan-y !important;
  padding-bottom: calc(180px + var(--safe-bottom, 0px)) !important;
}
#designModal{ align-items: flex-start !important; padding-top: 16px; } /* start at top so more room below */

  <div id="designModal" aria-hidden="true">
    <div id="designShade"></div>
    <div id="designCard" role="dialog" aria-modal="true">
      <button id="designClose" class="btn small">Schlie√üen</button>
      
    <div class="row" style="gap:.5rem; flex-wrap:wrap; margin:.35rem 0;">
      <button id="jumpLow" class="btn xsmall">Niedrig</button>
      <button id="jumpMid" class="btn xsmall">Mittel</button>
      <button id="jumpHigh" class="btn xsmall">Hoch</button>
      <button id="jumpUltra" class="btn xsmall primary">Ultra</button>
    </div>
    

      <div class="section">
        <strong>Niedrig</strong><div id="sec-low" style="position:relative;top:-8px;"></div>
        <div class="row"><label>Normaler Hintergrund</label><input id="lowBg" type="color" value="#110a1f"></div>
        <div class="row"><label>Spielfeld</label><input id="lowBoard" type="color" value="#2a1d4b"></div>
        <div class="row"><button id="applyLow" class="btn small primary">Anwenden</button> <button id="resetLow" class="btn small">Standard zur√ºcksetzen</button></div>
      </div>

      <div class="section">
        <strong>Mittel</strong><div id="sec-mid" style="position:relative;top:-8px;"></div>
        <div class="row"><label>Normaler Hintergrund</label><input id="midBg" type="color" value="#110a1f"></div>
        <div class="row"><label>Spielfeld</label><input id="midBoard" type="color" value="#2a1d4b"></div>
        <div class="row"><button id="applyMid" class="btn small primary">Anwenden</button> <button id="resetMid" class="btn small">Standard zur√ºcksetzen</button></div>
      </div>

      <div class="section">
        <strong>Hoch <span style="opacity:.8;">(Sterne bleiben aktiv)</span></strong>
        <div class="row"><label>Normaler Hintergrund</label><input id="highBg" type="color" value="#110a1f"></div>
        <div class="row"><label>Spielfeld</label><input id="highBoard" type="color" value="#2a1d4b"></div>
        <div class="row"><button id="applyHigh" class="btn small primary">Anwenden</button> <button id="resetHigh" class="btn small">Standard zur√ºcksetzen</button></div>
      </div>

      <div class="section">
        <strong>Ultra (Live‚ÄëHintergrund)</strong>
        <div class="row"><label>YouTube‚ÄëLink (nur Bild, ohne Ton)</label><input id="ultraLink" type="text" placeholder="https://youtu.be/..." class="field-input" style="width:24rem;"></div>
        <div class="row"><button id="applyUltra" class="btn small primary">Als Live‚ÄëHintergrund aktivieren</button> <button id="resetUltra" class="btn small">Standard zur√ºcksetzen</button></div>
        <div class="help">Der Clip wird stumm, automatisch und im Loop abgespielt. Keine Bedienung m√∂glich.</div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const $ = (sel)=>document.querySelector(sel);

    function ensureYTLayer(){
      const main = document.querySelector('main');
      if(!main) return;
      let bgc = document.getElementById('yt-live-bg');
      if(!bgc){
        bgc = document.createElement('div');
        bgc.id = 'yt-live-bg';
        const canvas = document.getElementById('bgCanvas');
        if(canvas && canvas.parentNode === main){
          main.insertBefore(bgc, canvas.nextSibling);
        }else{
          main.insertBefore(bgc, main.firstChild);
        }
      }
      return bgc;
    }

    function extractYTId(url){
      if(!url) return null;
      try{
        const u = new URL(url);
        if(u.hostname.includes('youtu.be')) return u.pathname.slice(1);
        if(u.searchParams.get('v')) return u.searchParams.get('v');
        const m = u.pathname.match(/embed\/([\w-]{11})/);
        if(m) return m[1];
      }catch(e){
        if(/^[\w-]{11}$/.test(url)) return url;
      }
      return null;
    }

    function applyColors(mode){
      const root = document.documentElement;
      const board = document.getElementById('board');
      const bg = localStorage.getItem('design_'+mode+'_bg');
      const bd = localStorage.getItem('design_'+mode+'_board');

      if(bg){ root.style.setProperty('--bg', bg); try{ document.body.style.background = bg; }catch(e){} }
      if(board && bd) board.style.background = bd;
    }

    function applyUltra(){
      
  // --- ensure Ultra stays transparent: clear any inline backgrounds from other modes ---
  try {
    const root = document.documentElement;
    root && root.style && root.style.removeProperty && root.style.removeProperty('--bg');
    if (document.body) document.body.style.background = '';
    const board = document.getElementById('board');
    if (board) board.style.background = '';
  } catch(e) { /* ignore */ }
const link = localStorage.getItem('design_ultra_yt');
      const ytId = extractYTId(link || '');
      const layer = ensureYTLayer();
      const bgCanvas = document.getElementById('bgCanvas');
      if(ytId && layer){
        const src = 'https://www.youtube.com/embed/'+ytId+'?autoplay=1&mute=1&controls=0&loop=1&playlist='+ytId+'&modestbranding=1&playsinline=1&rel=0&iv_load_policy=3&fs=0&disablekb=1';
        layer.innerHTML = '<iframe title="Live Hintergrund" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen="false" src="'+src+'"></iframe>';
        if(bgCanvas) bgCanvas.style.opacity = 0;
      }else{
        if(layer) layer.innerHTML = '';
        if(bgCanvas) bgCanvas.style.opacity = '';
      }
    }

    function currentPerfMode(){
      const btn = document.getElementById('btnPerf');
      if(!btn) return 'Hoch';
      const t = btn.textContent || '';
      if(t.includes('Ultra')) return 'Ultra';
      if(t.includes('Hoch')) return 'Hoch';
      if(t.includes('Mittel')) return 'Mittel';
      if(t.includes('Niedrig')) return 'Niedrig';
      return 'Hoch';
    }

    function applyDesignForCurrentMode(){
      const mode = currentPerfMode();
      if(mode === 'Ultra'){
        applyUltra();
      }else{
        const layer = document.getElementById('yt-live-bg');
        if(layer) layer.innerHTML = '';
        const bgCanvas = document.getElementById('bgCanvas');
        if(bgCanvas) bgCanvas.style.opacity = '';
        const map = { 'Niedrig':'low', 'Mittel':'mid', 'Hoch':'high' };
        applyColors(map[mode] || 'high');
      }
    }

    function openDesign(){ $('#designModal').style.display = 'flex'; loadFields(); 
  try{
    var card = document.getElementById('designCard');
    if(card){
      // Reset to top so Ultra ist erreichbar durchs Scrollen
      card.scrollTop = 0;
      // Stop bubbling so Body-Lock blockiert nicht
      var _stop = function(e){ e.stopPropagation(); };
      card.addEventListener('touchmove', _stop, {passive:true});
      card.addEventListener('wheel', _stop, {passive:true});
    }
  }catch(e){}
}

    function closeDesign(){ $('#designModal').style.display = 'none'; }

    function loadFields(){
      const pairs = [
        ['low','#lowBg','#lowBoard'],
        ['mid','#midBg','#midBoard'],
        ['high','#highBg','#highBoard']
      ];
      pairs.forEach(([k,bgSel,bdSel])=>{
        const bg = localStorage.getItem('design_'+k+'_bg');
        const bd = localStorage.getItem('design_'+k+'_board');
        if(bg && $(bgSel)) $(bgSel).value = bg;
        if(bd && $(bdSel)) $(bdSel).value = bd;
      });
      const u = localStorage.getItem('design_ultra_yt');
      if(u && $('#ultraLink')) $('#ultraLink').value = u;
    }

    function saveColors(k, bgSel, bdSel){
      const bg = $(bgSel).value;
      const bd = $(bdSel).value;
      localStorage.setItem('design_'+k+'_bg', bg);
      localStorage.setItem('design_'+k+'_board', bd);
      applyDesignForCurrentMode();
    }

    function saveUltra(){
      const link = $('#ultraLink').value.trim();
      localStorage.setItem('design_ultra_yt', link);
      applyDesignForCurrentMode();
    }

    

    function resetColors(k){
      const DEFAULTS = {
        low:  { bg:'#110a1f', board:'#2a1d4b' },
        mid:  { bg:'#110a1f', board:'#2a1d4b' },
        high: { bg:'#110a1f', board:'#2a1d4b' }
      };
      localStorage.removeItem('design_'+k+'_bg');
      localStorage.removeItem('design_'+k+'_board');
      // If current mode equals the reset key, immediately apply defaults
      const cur = currentPerfMode();
      const key = (cur==='Niedrig') ? 'low' : (cur==='Mittel') ? 'mid' : (cur==='Hoch') ? 'high' : null;
      if(key === k){
        const def = DEFAULTS[k];
        if(def){
          document.documentElement.style.setProperty('--bg', def.bg);
          try{ document.body.style.background = def.bg; }catch(e){}
          const board = document.getElementById('board');
          if(board) board.style.background = def.board;
        }
      }
      loadFields();
    }

    function resetUltra(){
      localStorage.removeItem('design_ultra_yt');
      const layer = document.getElementById('yt-live-bg'); if(layer) layer.innerHTML='';
      const bgCanvas = document.getElementById('bgCanvas'); if(bgCanvas) bgCanvas.style.opacity='';
      loadFields();
      if(currentPerfMode() === 'Ultra'){ applyDesignForCurrentMode(); }
    }
document.addEventListener('DOMContentLoaded', function(){
      const trigger = document.getElementById('btnDesignOpen');
      if(trigger) trigger.addEventListener('click', openDesign);
      const shade = document.getElementById('designShade');
      const close = document.getElementById('designClose');
      if(shade) shade.addEventListener('click', closeDesign);
      if(close) close.addEventListener('click', closeDesign);

      const btnPerf = document.getElementById('btnPerf');
      if(btnPerf){
        btnPerf.addEventListener('click', function(){ setTimeout(applyDesignForCurrentMode, 0); });
      }
      applyDesignForCurrentMode();

      const b1 = document.getElementById('applyLow'); if(b1) b1.addEventListener('click', ()=>saveColors('low','#lowBg','#lowBoard'));
      const b2 = document.getElementById('applyMid'); if(b2) b2.addEventListener('click', ()=>saveColors('mid','#midBg','#midBoard'));
      const b3 = document.getElementById('applyHigh'); if(b3) b3.addEventListener('click', ()=>saveColors('high','#highBg','#highBoard'));
      const b4 = document.getElementById('applyUltra'); if(b4) b4.addEventListener('click', saveUltra);
    });
  })();
  </script>



<script>
(function(){
  function isWithinScrollable(t){ return t && t.closest && t.closest('[data-scrollable]'); }
  window.addEventListener('wheel', function(e){ if (e.ctrlKey) e.preventDefault(); }, { passive:false });
  window.addEventListener('gesturestart', function(e){ e.preventDefault(); });
  var lastTouchEnd = 0;
  document.addEventListener('touchend', function(e){ var now=Date.now(); if(now - lastTouchEnd <= 300){ e.preventDefault(); } lastTouchEnd = now; }, { passive:false });
  document.addEventListener('touchmove', function(e){ if(isWithinScrollable(e.target)) return; e.preventDefault(); }, { passive:false });

  function markScrollable(){
    ['#dlgAccount', '#dlgAdminLogin', '#topList', '.modal', '.panel', '.account', '.leaderboard'].forEach(function(sel){
      document.querySelectorAll(sel).forEach(function(el){ el.setAttribute('data-scrollable','1'); });
    });
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', markScrollable, {once:true}); else markScrollable();

  var brand = document.getElementById('brandText');
  function applyBrand(){
    if(!brand) return;
    if (window.matchMedia('(max-width: 640px)').matches) brand.textContent = 'e.m.3';
    else brand.textContent = 'Emoji Match 3';
  }
  applyBrand();
  window.addEventListener('resize', applyBrand);
  window.addEventListener('orientationchange', applyBrand);
})();
</script>
<script>
/* --- Page: lock zoom & outer scroll; allow internal [data-scrollable] scroll --- */
(() => {
  document.querySelectorAll('.modal-body').forEach(el => el.setAttribute('data-scrollable',''));
  ['gesturestart','gesturechange','gestureend'].forEach(evt => {
    document.addEventListener(evt, e => e.preventDefault(), { passive: false });
  });
  window.addEventListener('wheel', (e) => {
    if (e.ctrlKey || !e.target.closest('[data-scrollable]')) e.preventDefault();
  }, { passive: false });
})();
</script>
<script>
/* ==== Mobile refine script v5 (layout + labels) ==== */
(function(){
  const isMobile = window.matchMedia("(max-width: 768px), (pointer: coarse)").matches;
  if (!isMobile) return;

  // Ensure a mini reload button exists (we'll reposition it later)
  (function ensureReload(){
    if (document.querySelector('.btn-reload-mobile')) return;
    const b = document.createElement('button');
    b.className = 'btn-reload-mobile';
    b.setAttribute('aria-label','Reload');
    b.textContent = '‚Üª';
    b.style.position = 'fixed';
    b.style.width = '36px'; b.style.height = '36px';
    b.style.borderRadius = '9999px';
    b.style.border = '1px solid rgba(255,255,255,.25)';
    b.style.background = 'rgba(0,0,0,.35)';
    b.style.backdropFilter = 'blur(6px)';
    b.style.fontSize = '18px';
    b.style.lineHeight = '36px';
    b.style.textAlign = 'center';
    b.style.color = 'var(--fg,#fff)';
    b.style.zIndex = '9999';
    b.style.userSelect = 'none';
    b.addEventListener('click', () => location.reload());
    document.body.appendChild(b);
  })();

  // Replace "Performance:" -> "Per:" (mobile only)
  try {
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
    const nodes = [];
    while (walker.nextNode()) {
      const n = walker.currentNode, t = (n.nodeValue || '');
      if (/^\s*Performance\s*:?\s*$/.test(t)) nodes.push(n);
    }
    nodes.forEach(n => n.nodeValue = 'Per:');
    const candidates = Array.from(document.querySelectorAll('[data-label="performance"], .perf-label, label, .label, .btn, .chip'))
      .filter(el => /^Performance\s*:?\s*$/i.test(el.textContent.trim()));
    candidates.forEach(el => el.textContent = 'Per:');
  } catch(e){}

  // Find performance bar container and scale it a bit so it fits under the header
  function findPerfBar(){
    const nodes = Array.from(document.querySelectorAll('*')).filter(el => {
      const t = (el.textContent || '').replace(/\s+/g,' ').trim();
      return /Niedrig/i.test(t) && /Mittel/i.test(t) && /Hoch/i.test(t) && /Ultra/i.test(t); questOnScoreChanged(score);
    });
    let pick = null, score = 1e15;
    nodes.forEach(el => {
      const r = el.getBoundingClientRect();
      const area = Math.max(1, r.width*r.height); questOnScoreChanged(score);
      const s = area + el.children.length * 2000;
      if (s < score) { score = s; pick = el; }
    });
    return pick;
  }
  const perfBar = findPerfBar();
  if (perfBar) {
    perfBar.classList.add('perfbar--mobile-scale');
    perfBar.style.marginTop = '4px';
  }

  // Place Bestenliste & Neustart top-right directly below perf bar (not mid-game)
  function pickByText(txt) {
    const els = Array.from(document.querySelectorAll('button, a, .btn, [role="button"]'));
    return els.find(el => el.textContent.trim().toLowerCase() === txt.toLowerCase());
  }
  const leaderboardBtn =
    document.querySelector('[data-action="leaderboard"], [data-role="leaderboard"]') ||
    pickByText('Bestenliste');
  const restartBtn =
    document.querySelector('[data-action="restart"], [data-role="restart"]') ||
    pickByText('Neustart');

  let anchorTop = 0;
  const header = document.querySelector('header, .header, .topbar');
  if (perfBar) {
    anchorTop = Math.round(perfBar.getBoundingClientRect().bottom) + 6;
  } else if (header) {
    anchorTop = Math.round(header.getBoundingClientRect().bottom) + 6;
  } else {
    anchorTop = 80;
  }
  function floatAt(btn, y){
    if (!btn) return;
    btn.classList.add('floating-mobile-action');
    Object.assign(btn.style, { position:'fixed', right:'8px', top:y+'px', zIndex:'9999' });
  }
  floatAt(leaderboardBtn, anchorTop);
  floatAt(restartBtn, anchorTop + 42);

  // Place reload between Info and FPS at the bottom baseline
  function placeReload(){
    const infoEl = Array.from(document.querySelectorAll('*')).find(el => el.textContent && el.textContent.trim() === 'Info');
    const fpsEl  = Array.from(document.querySelectorAll('*')).find(el => /^\s*FPS\s*:/.test(el.textContent || ''));
    const rb = document.querySelector('.btn-reload-mobile');
    if (!rb || !infoEl || !fpsEl) return;
    rb.style.bottom = 'calc(var(--safe-bottom, 0px) + 6px)';
    const ir = infoEl.getBoundingClientRect();
    const fr = fpsEl.getBoundingClientRect();
    const centerX = (ir.right + fr.left) / 2;
    const width = rb.getBoundingClientRect().width || 36;
    const left = Math.max(8, centerX - width/2);
    rb.style.left = left + 'px';
    rb.style.right = 'auto';
  }
  placeReload();
  ['resize','orientationchange'].forEach(evt => window.addEventListener(evt, placeReload, {passive:true}));
})();
</script>
<script>
/* ==== Mobile refine v6 script ==== */
(function(){
  const isMobile = window.matchMedia("(max-width: 768px), (pointer: coarse)").matches;
  if (!isMobile) return;

  function pickByText(txt) {
    const els = Array.from(document.querySelectorAll('button, a, .btn, [role="button"], .chip, .badge, span, div'));
    return els.find(el => el.textContent && el.textContent.trim().toLowerCase() === txt.toLowerCase());
  }

  // 1) Ensure header and add a right-side container for mini buttons
  const header = document.querySelector('header, .header, .topbar');
  if (header) {
    let right = header.querySelector('.header-right-stack');
    if (!right) {
      right = document.createElement('div');
      right.className = 'header-right-stack';
      header.appendChild(right);
    }

    // Grab original large buttons
    const lbOrig =
      document.querySelector('[data-action="leaderboard"], [data-role="leaderboard"]') ||
      pickByText('Bestenliste');
    const rsOrig =
      document.querySelector('[data-action="restart"], [data-role="restart"]') ||
      pickByText('Neustart');

    function makeMini(original, label){
      if (!original) return null;
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'mini-top-btn';
      b.textContent = label;
      b.addEventListener('click', (e) => { e.preventDefault(); original.click(); });
      return b;
    }

    const lbMini = makeMini(lbOrig, 'Bestenliste');
    const rsMini = makeMini(rsOrig, 'Neustart');
    if (lbMini) right.appendChild(lbMini);
    if (rsMini) right.appendChild(rsMini);

    // Hide the big versions to avoid overlaying content
    if (lbOrig) { lbOrig.style.display = 'none'; lbOrig.classList.add('floating-mobile-action'); }
    if (rsOrig) { rsOrig.style.display = 'none'; rsOrig.classList.add('floating-mobile-action'); }
  }

  // 2) Keep bottom HUD (Konto/Info/FPS) fixed flush to bottom
  (function fixBottomHUD(){
    // Try to find Info + FPS; then pin their common parent
    const infoEl = pickByText('Info');
    const fpsEl  = Array.from(document.querySelectorAll('*')).find(el => /^\s*FPS\s*:/.test(el.textContent || ''));
    function ancestors(el){ const arr=[]; while(el){ arr.push(el); el = el.parentElement; } return arr; }
    let hud = null;
    if (infoEl && fpsEl) {
      const ai = ancestors(infoEl);
      const af = ancestors(fpsEl);
      hud = ai.find(n => af.includes(n));
    }
    if (hud) {
      hud.classList.add('hud-bottom-fixed');
    } else {
      // Fallback: position individually so they sit on the baseline
      if (infoEl) {
        Object.assign(infoEl.style, {position:'fixed', left:'50%', transform:'translateX(-50%)', bottom:'calc(var(--safe-bottom,0px) + 4px)', zIndex:'901'});
      }
      if (fpsEl) {
        Object.assign(fpsEl.style, {position:'fixed', right:'8px', bottom:'calc(var(--safe-bottom,0px) + 4px)', zIndex:'901'});
      }
    }
  })();

  // 3) Reload button exactly between Info and FPS on the same bottom baseline
  (function placeReload(){
    let rb = document.querySelector('.btn-reload-mobile');
    if (!rb) {
      rb = document.createElement('button');
      rb.className = 'btn-reload-mobile';
      rb.setAttribute('aria-label', 'Reload');
      rb.textContent = '‚Üª';
      rb.style.width = '36px'; rb.style.height = '36px';
      rb.style.borderRadius = '9999px';
      rb.style.border = '1px solid rgba(255,255,255,.18)';
      rb.style.background = 'rgba(0,0,0,.25)';
      rb.style.backdropFilter = 'blur(6px)';
      rb.style.fontSize = '18px';
      rb.style.lineHeight = '36px';
      rb.style.textAlign = 'center';
      rb.style.color = 'var(--fg,#fff)';
      rb.style.userSelect = 'none';
      rb.addEventListener('click', () => location.reload());
      document.body.appendChild(rb);
    }
    function positionRB(){
      const infoEl = pickByText('Info');
      const fpsEl  = Array.from(document.querySelectorAll('*')).find(el => /^\s*FPS\s*:/.test(el.textContent || ''));
      if (!infoEl || !fpsEl) return;
      const ir = infoEl.getBoundingClientRect();
      const fr = fpsEl.getBoundingClientRect();
      const cx = (ir.right + fr.left) / 2;
      const w  = rb.getBoundingClientRect().width || 36;
      rb.style.left = Math.max(8, cx - w/2) + 'px';
      rb.style.right = 'auto';
      rb.style.bottom = 'calc(var(--safe-bottom, 0px) + 4px)';
    }
    positionRB();
    ['resize','orientationchange'].forEach(evt => window.addEventListener(evt, positionRB, {passive:true}));
  })();

  // 4) On mobile: label "Performance:" -> "Per:" (without touching theme behavior)
  try {
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
    const nodes = [];
    while (walker.nextNode()) {
      const n = walker.currentNode, t = (n.nodeValue || '');
      if (/^\s*Performance\s*:?\s*$/.test(t)) nodes.push(n);
    }
    nodes.forEach(n => n.nodeValue = 'Per:');
    const candidates = Array.from(document.querySelectorAll('[data-label="performance"], .perf-label, label, .label'))
      .filter(el => /^Performance\s*:?\s*$/i.test(el.textContent.trim()));
    candidates.forEach(el => el.textContent = 'Per:');
  } catch(e){}
})();
</script>
<script>
/* ==== Mobile refine v7 script ==== */
(function(){
  const isMobile = window.matchMedia("(max-width: 768px), (pointer: coarse)").matches;
  if (!isMobile) return;

  function pickByText(txt) {
    const els = Array.from(document.querySelectorAll('button, a, .btn, [role="button"], .chip, .badge, span, div'));
    return els.find(el => el.textContent && el.textContent.trim().toLowerCase() === txt.toLowerCase());
  }

  // 0) Remove any reload button that might have been injected earlier
  document.querySelectorAll('.btn-reload-mobile').forEach(el => el.remove());

  // 1) Ensure header-right container exists
  const header = document.querySelector('header, .header, .topbar');
  let right = header ? header.querySelector('.header-right-stack') : null;
  if (header && !right) {
    right = document.createElement('div');
    right.className = 'header-right-stack';
    header.appendChild(right);
  }

  // 2) Find original big buttons (to trigger their actions) and hide them on mobile
  const lbOrig =
    document.querySelector('[data-action="leaderboard"], [data-role="leaderboard"]') ||
    pickByText('Bestenliste');
  const rsOrig =
    document.querySelector('[data-action="restart"], [data-role="restart"]') ||
    pickByText('Neustart');
  if (lbOrig) lbOrig.style.display = 'none';
  if (rsOrig) rsOrig.style.display = 'none';

  // 3) Find a Performance chip element to clone classes from (for the visual style)
  function findPerfChip(){
    // Prefer a single option element (e.g., "Niedrig")
    const options = ['Niedrig','Mittel','Hoch','Ultra'];
    for (const label of options) {
      const el = pickByText(label);
      if (el) return el;
    }
    // Fallback: try common class names
    const byCls = document.querySelector('.perf-option, .performance-option, .chip-perf, .perf-chip, [data-perf]');
    return byCls || null;
  }
  const perfChip = findPerfChip();
  const perfClasses = perfChip ? Array.from(perfChip.classList) : [];

  // 4) Make mini buttons in header-right with same class set as perf chips
  function makeMini(original, label){
    if (!original || !right) return null;
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'mini-top-btn match-perf-chip';
    perfClasses.forEach(cls => b.classList.add(cls));
    b.textContent = label;
    b.addEventListener('click', (e) => { e.preventDefault(); original.click(); });
    right.appendChild(b);
    return b;
  }
  // Clear previous (if script re-runs)
  if (right) right.innerHTML = '';
  const lbMini = makeMini(lbOrig, 'Bestenliste');
  const rsMini = makeMini(rsOrig, 'Neustart');

  // 5) Keep bottom HUD (Konto/Info/FPS) pinned to bottom if not already handled by base CSS
  (function ensureBottomHUD(){
    const infoEl = pickByText('Info');
    const fpsEl  = Array.from(document.querySelectorAll('*')).find(el => /^\s*FPS\s*:/.test(el.textContent || ''));
    if (!infoEl || !fpsEl) return;
    // Try to pin their shared container
    function ancestors(el){ const arr=[]; while(el){ arr.push(el); el = el.parentElement; } return arr; }
    let hud = null;
    const ai = ancestors(infoEl);
    const af = ancestors(fpsEl);
    hud = ai.find(n => af.includes(n));
    if (hud) {
      hud.style.position = 'fixed';
      hud.style.left = '0';
      hud.style.right = '0';
      hud.style.bottom = 'calc(var(--safe-bottom, 0px) + 4px)';
      hud.style.zIndex = '900';
    }
  })();

  // 6) Keep "Performance:" -> "Per:" label swap (non-destructive)
  try {
    const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
    const nodes = [];
    while (walker.nextNode()) {
      const n = walker.currentNode, t = (n.nodeValue || '');
      if (/^\s*Performance\s*:?\s*$/.test(t)) nodes.push(n);
    }
    nodes.forEach(n => n.nodeValue = 'Per:');
    const candidates = Array.from(document.querySelectorAll('[data-label="performance"], .perf-label, label, .label'))
      .filter(el => /^Performance\s*:?\s*$/i.test(el.textContent.trim()));
    candidates.forEach(el => el.textContent = 'Per:');
  } catch(e){}
})();
</script>
<script>
</script>
<script>
</script>
<script>
// v15: quick jump buttons to sections in design modal
document.addEventListener('click', function(ev){
  var t = ev.target;
  if(!(t instanceof Element)) return;
  var card = document.getElementById('designCard');
  if(!card) return;
  var toId = t.id === 'jumpLow' ? 'sec-low' :
             t.id === 'jumpMid' ? 'sec-mid' :
             t.id === 'jumpHigh' ? 'sec-high' :
             t.id === 'jumpUltra' ? 'sec-ultra' : null;
  if(toId){
    var target = document.getElementById(toId);
    if(target){
      target.scrollIntoView({block:'start', behavior:'smooth'});
    }
  }
}, {passive:true});
</script>
<div id="ytp-holder" style="position:fixed;left:-9999px;top:auto;width:1px;height:1px;opacity:0;pointer-events:none"></div>
<script>
</script>
<script>
// --- OFFICIAL v19: Mobile/Chromebook YouTube music with safe origin ---
(function(){
  function extractYouTubeId(url){
    if(!url) return null;
    url = String(url).trim();
    var m;
    if(/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
    m = url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/); if(m) return m[1];
    m = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/); if(m) return m[1];
    m = url.match(/embed\/([a-zA-Z0-9_-]{11})/); if(m) return m[1];
    m = url.match(/shorts\/([a-zA-Z0-9_-]{11})/); if(m) return m[1];
    return null;
  }

  function ensureIframe(){
    var holder = document.getElementById('ytp-holder');
    if(!holder){
      holder = document.createElement('div');
      holder.id = 'ytp-holder';
      holder.style.cssText = 'position:fixed;left:-9999px;top:auto;width:1px;height:1px;opacity:0;pointer-events:none';
      document.body.appendChild(holder);
    }
    var iframe = document.getElementById('ytp');
    if(!iframe){
      iframe = document.createElement('iframe');
      iframe.id = 'ytp';
      iframe.width = '1'; iframe.height = '1';
      iframe.setAttribute('frameborder','0');
      iframe.setAttribute('allow','autoplay; encrypted-media; picture-in-picture; clipboard-write');
      iframe.setAttribute('allowfullscreen','false');
      holder.appendChild(iframe);
    }
    return iframe;
  }

  function isHttpOrigin(){
    try{
      return location.protocol === 'https:' || location.protocol === 'http:';
    }catch(e){ return false; }
  }

  function playYT(){
    var inp = document.getElementById('ytUrl');
    var id = extractYouTubeId(inp && inp.value);
    if(!id){ alert('Bitte g√ºltigen YouTube-Link oder die Video-ID eingeben.'); return; }

    var iframe = ensureIframe();
    // Build src using youtube-nocookie and only add origin if http(s)
    var base = 'https://www.youtube-nocookie.com/embed/' + id;
    var params = ['autoplay=1','playsinline=1','rel=0','modestbranding=1','enablejsapi=1'];
    if(isHttpOrigin()){
      try{ params.push('origin=' + encodeURIComponent(location.origin)); }catch(e){}
    }
    if(document.getElementById('chkLoopYT')?.checked){ params.push('loop=1','playlist='+id); }
    var src = base + '?' + params.join('&');

    // Force reload (helps Chrome when same id)
    try{ iframe.src = ''; }catch(e){}
    iframe.src = src;
  }

  function stopYT(){
    var iframe = document.getElementById('ytp');
    if(iframe) iframe.src = '';
  }

  function bind(){
    var play = document.getElementById('btnPlayYT');
    var stop = document.getElementById('btnStopYT');
    if(play){
      // pointerdown ensures best iOS compatibility; click is fallback
      var h = function(){ playYT(); };
      play.addEventListener('pointerdown', h, {passive:true});
      play.addEventListener('click', h, {passive:true});
    }
    if(stop){
      stop.addEventListener('click', function(){ stopYT(); }, {passive:true});
    }
  }

  // Bind asap
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  }else{
    bind();
  }
})();
</script>

<!-- v21: New YouTube play button handler -->
<script>
(function(){
  function extractYouTubeId(url){
    if(!url) return null;
    url = String(url).trim();
    var m;
    if(/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
    m = url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/); if(m) return m[1];
    m = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/); if(m) return m[1];
    m = url.match(/embed\/([a-zA-Z0-9_-]{11})/); if(m) return m[1];
    m = url.match(/shorts\/([a-zA-Z0-9_-]{11})/); if(m) return m[1];
    return null;
  }
  function ensureHolder(){
    var holder = document.getElementById('ytp-holder');
    if(!holder){
      holder = document.createElement('div');
      holder.id = 'ytp-holder';
      holder.style.cssText = 'position:fixed;left:-9999px;top:auto;width:1px;height:1px;opacity:0;pointer-events:none';
      document.body.appendChild(holder);
    }
    return holder;
  }
  function ensureIframe(){
    var iframe = document.getElementById('ytp');
    if(!iframe){
      var holder = ensureHolder();
      iframe = document.createElement('iframe');
      iframe.id = 'ytp';
      iframe.width = '1'; iframe.height = '1';
      iframe.setAttribute('frameborder','0');
      iframe.setAttribute('allow','autoplay; encrypted-media; picture-in-picture; clipboard-write');
      iframe.setAttribute('allowfullscreen','false');
      holder.appendChild(iframe);
    }
    return iframe;
  }
  function isHttpOrigin(){
    try{ return location.protocol === 'https:' || location.protocol === 'http:'; }catch(e){ return false; }
  }
  function playNow(){
    var inp = document.getElementById('ytUrl');
    var id = extractYouTubeId(inp && inp.value);
    if(!id){ alert('Bitte g√ºltigen YouTube-Link oder die Video-ID eingeben.'); return; }
    var iframe = ensureIframe();
    var base = 'https://www.youtube-nocookie.com/embed/' + id;
    var params = ['autoplay=1','playsinline=1','rel=0','modestbranding=1','enablejsapi=1'];
    if(isHttpOrigin()){
      try{ params.push('origin=' + encodeURIComponent(location.origin)); }catch(e){}
    }
    iframe.src = base + '?' + params.join('&');
  }
  function bind(){
    var btn = document.getElementById('btnYTPlay');
    if(!btn) return;
    var h = function(){ playNow(); };
    btn.addEventListener('pointerdown', h, {passive:true});
    btn.addEventListener('click', h, {passive:true});
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  } else { bind(); }
})();
</script>














<script>
// v25: Clean YouTube Music module (fresh build) ‚Äî ONLY affects yt music (not live bg)
(function(){
  var apiReady = false, player = null, playerReady = false, pendingId = null;

  // Utility: extract video id from various URL formats or direct 11-char ID
  function extractId(url){
    if(!url) return null;
    url = String(url).trim();
    if(/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
    var m;
    m = url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/); if(m) return m[1];
    m = url.match(/[?&]v=([a-zA-Z0-9_-]{11})/); if(m) return m[1];
    m = url.match(/embed\/([a-zA-Z0-9_-]{11})/); if(m) return m[1];
    m = url.match(/shorts\/([a-zA-Z0-9_-]{11})/); if(m) return m[1];
    return null;
  }

  // Prefer the same background layer (safe z-index behind UI) else offscreen holder
  function ensureContainer(){
    var layer = document.getElementById('yt-live-bg');
    if(layer){
      var mc = document.getElementById('yt-music');
      if(!mc){
        mc = document.createElement('div');
        mc.id = 'yt-music';
        mc.style.cssText = 'position:absolute; right:8px; bottom:8px; width:2px; height:2px; overflow:hidden; z-index:1;';
        layer.appendChild(mc);
      }
      return mc;
    }
    var holder = document.getElementById('ytp-holder');
    if(!holder){
      holder = document.createElement('div');
      holder.id = 'ytp-holder';
      holder.style.cssText = 'position:fixed;left:-9999px;top:auto;width:1px;height:1px;opacity:0;pointer-events:none';
      document.body.appendChild(holder);
    }
    return holder;
  }

  // Feedback utilities (tiny toast + button press effect)
  function ensureStatus(){
    var s = document.getElementById('yt-status');
    if(!s){
      // place status right after play button row if possible
      var playBtn = document.getElementById('btnYTPlay');
      if(playBtn && playBtn.parentElement){
        var row = playBtn.parentElement;
        var holder = document.createElement('div');
        holder.id = 'yt-status';
        holder.style.cssText = 'margin-top:.35rem;text-align:center;font-size:.9rem;color:#e8e6ff;opacity:.9;';
        row.insertAdjacentElement('afterend', holder);
        s = holder;
      }
    }
    return s;
  }
  function setStatus(msg){
    var s = ensureStatus();
    if(s){ s.textContent = msg; }
  }
  function clearStatus(){
    var s = document.getElementById('yt-status');
    if(s){ s.textContent = ''; }
  }
  function ensureToast(){
    var t = document.getElementById('yt-toast');
    if(!t){
      t = document.createElement('div');
      t.id = 'yt-toast';
      t.style.cssText = 'position:fixed;left:50%;bottom:18px;transform:translateX(-50%);'+
                        'background:#2a2146;color:#fff;padding:8px 12px;border-radius:12px;'+
                        'font-size:14px;box-shadow:0 6px 20px rgba(0,0,0,.35);z-index:999999;opacity:0;transition:opacity .15s ease';
      document.body.appendChild(t);
    }
    return t;
  }
  function toast(msg,dur){
    var t = ensureToast();
    t.textContent = msg;
    t.style.opacity = '1';
    clearTimeout(t._h);
    t._h = setTimeout(function(){ t.style.opacity = '0'; }, dur||1400);
  }
  function pressFX(btn){
    btn.style.transform = 'scale(0.98)'; btn.style.opacity='0.9';
    setTimeout(function(){ btn.style.transform=''; btn.style.opacity=''; }, 110);
  }
  function setBtnStateRunning(running){
    var btn = document.getElementById('btnYTPlay');
    if(!btn) return;
    if(running){
      btn.dataset.label = btn.dataset.label || btn.textContent;
      btn.textContent = 'L√§uft ‚úÖ';
      setTimeout(function(){ if(btn.dataset.label){ btn.textContent = btn.dataset.label; }}, 1400);
    }
  }

  // Load YT Iframe API once (do not touch any other modules)
  function loadApiOnce(){
    if(window.YT && YT.Player){ apiReady = true; return; }
    if(window._ytMusicApiRequested) return;
    window._ytMusicApiRequested = true;
    var tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(tag);
  }
  window.onYouTubeIframeAPIReady = (function(orig){
    return function(){
      apiReady = true;
      if(typeof orig === 'function') try{ orig(); }catch(e){}
      ensurePlayer();
      if(pendingId && playerReady) playId(pendingId);
    };
  })(window.onYouTubeIframeAPIReady);

  function ensurePlayer(){
    if(player || !apiReady) return;
    var cont = ensureContainer();
    var anchor = document.createElement('div');
    anchor.id = 'yt-music-anchor';
    cont.innerHTML = ''; // clear prior iframes
    cont.appendChild(anchor);
    player = new YT.Player(anchor, {
      width: 160, height: 90,
      playerVars: { autoplay: 0, controls: 0, rel: 0, modestbranding: 1, playsinline: 1 },
      events: {
        onReady: function(){ playerReady = true; if(pendingId){ playId(pendingId); } },
        onError: function(e){ console.warn('YT music error', e); if(e && (e.data===150 || e.data===101)){ setStatus('Diese Datei ist nicht abspielbar.'); } else { toast('YouTube Fehler ('+(e && e.data)+')', 1800); } }
      }
    });
  }

  function playId(id){
    pendingId = id;
    if(player && playerReady){
      try{
        player.unMute && player.unMute();
        player.setVolume && player.setVolume(100);
        player.loadVideoById({videoId:id, startSeconds:0, suggestedQuality:'small'});
        player.playVideo && player.playVideo();
        setBtnStateRunning(true);
        toast('YouTube l√§uft', 1000);
      }catch(e){
        console.warn(e);
      }
    }else{
      // Fallback until API/player ready: create tiny visible embed immediately (triggers audio via gesture)
      var cont = ensureContainer();
      cont.innerHTML = '<iframe title="YouTube Musik" width="160" height="90" style="width:160px;height:90px;opacity:0.001" frameborder="0" allow="autoplay; encrypted-media" src="https://www.youtube.com/embed/'+id+'?autoplay=1&playsinline=1&rel=0&modestbranding=1"></iframe>';
      setBtnStateRunning(true);
      toast('YouTube gestartet (Fallback)', 1200);
    }
  }

  function startMusic(){ clearStatus();
    var btn = document.getElementById('btnYTPlay');
    var inp = document.getElementById('ytUrl');
    if(!btn || !inp) return;
    pressFX(btn);
    // Diagnose if something overlays the button
    try{
      var r = btn.getBoundingClientRect();
      var topEl = document.elementFromPoint(r.left+r.width/2, r.top+r.height/2);
      if(topEl && topEl !== btn && !btn.contains(topEl)){
        btn.style.zIndex = '999999'; setTimeout(function(){ btn.style.zIndex=''; }, 200);
      }
    }catch(e){}
    var id = extractId(inp.value);
    if(!id){ toast('Bitte g√ºltigen YouTube-Link/ID eingeben.', 1600); return; }
    loadApiOnce(); ensurePlayer(); playId(id);
  }

  function pauseMusic(){
    // Try to pause; if not possible (fallback iframe), stop as best effort
    try{ if(player && player.pauseVideo) { player.pauseVideo(); toast('Pause', 700); return; } }catch(e){}
    var cont = document.getElementById('yt-music') || document.getElementById('ytp-holder');
    if(cont){ cont.innerHTML = ''; }
    toast('Pause (gestoppt mangels API)', 1000);
  }
  function stopMusic(){ clearStatus();
    var btn = document.getElementById('btnYTPlay');
    if(btn && btn.dataset && btn.dataset.label) btn.textContent = btn.dataset.label;
    // Stop API player if exists
    try{ player && player.stopVideo && player.stopVideo(); }catch(e){}
    // Also clear fallback iframe if present
    var cont = document.getElementById('yt-music') || document.getElementById('ytp-holder');
    if(cont) cont.innerHTML = '';
    toast('YouTube gestoppt', 800);
  }

  function bind(){
    var playBtn = document.getElementById('btnYTPlay');
    var stopBtn = document.getElementById('btnStopYT');
    if(playBtn){
      playBtn.addEventListener('pointerdown', function(){ startMusic(); }, {passive:true});
      playBtn.addEventListener('click', function(){ startMusic(); }, {passive:true});
    }
    if(stopBtn){
      stopBtn.addEventListener('click', function(){ stopMusic(); }, {passive:true});
      stopBtn.addEventListener('pointerdown', function(){ /* no-op visual */ }, {passive:true});
    }
    var pauseBtn = document.getElementById('btnPauseYT');
    if(pauseBtn){
      pauseBtn.addEventListener('click', function(){ pauseMusic(); }, {passive:true});
      pauseBtn.addEventListener('pointerdown', function(){ /* visual in pause */ }, {passive:true});
    }
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', function(){ loadApiOnce(); bind(); });
  }else{
    loadApiOnce(); bind();
  }
})();
</script>


<script>
// === Per-tile palette (low/mid/high) ‚Äî Ultra remains unchanged ===
(function(){
  const alias = { low:'low', niedrig:'low', mittel:'mid', medium:'mid', hoch:'high', high:'high' };
  function keyFor(mode){
    let m = (mode||'').toLowerCase();
    if(alias[m]) m = alias[m];
    return m;
  }
  function lsKey(modeKey){
    return modeKey === 'low' ? 'design_low_tiles'
         : modeKey === 'mid' ? 'design_mid_tiles'
         : modeKey === 'high' ? 'design_high_tiles'
         : null;
  }
  function getTilePalette(modeKey){
    const k = lsKey(modeKey);
    if(!k) return null;
    try{
      const raw = localStorage.getItem(k);
      if(!raw) return null;
      const arr = JSON.parse(raw);
      if(Array.isArray(arr) && arr.length) return arr.slice(0,64);
    }catch(e){}
    return null;
  }
  function saveTilePalette(modeKey, arr){
    const k = lsKey(modeKey);
    if(!k) return;
    try{ localStorage.setItem(k, JSON.stringify(arr.slice(0,64))); }catch(e){}
  }
  function clearTilePalette(modeKey){
    const k = lsKey(modeKey);
    if(!k) return;
    try{ localStorage.removeItem(k); }catch(e){}
  }
  // Try to detect current mode
  function currentModeKey(){
    const dm = (document.body.getAttribute('data-mode')||'').toLowerCase();
    return keyFor(dm);
  }
  // Apply palette to current grid (only for low/mid/high)
  window.applyTilePalette = function(modeKey){
    try{
      const curKey = currentModeKey();
      if(curKey === 'ultra'){
        if(window.tileEls && tileEls.length){
          for(let i=0;i<tileEls.length;i++){
            const el = tileEls[i];
            if(el && el.style) el.style.backgroundColor = '';
          }
        }
        return;
      }
      const mk = keyFor(modeKey||curKey);
      if(mk !== 'low' && mk !== 'mid' && mk !== 'high') return;
      const arr = getTilePalette(mk);
      if(window.tileEls && tileEls.length){
        for(let i=0;i<tileEls.length;i++){
          const el = tileEls[i];
          if(!el || !el.style) continue;
          const c = arr && arr[i] || null;
          if(c){ el.style.backgroundColor = c; }
          else { el.style.backgroundColor = ''; }
        }
      }
    }catch(e){ console.warn('applyTilePalette failed', e); }
  };
  document.addEventListener('DOMContentLoaded', function(){
    try{ window.applyTilePalette(); }catch(e){}
  });
  // Hook initGrid if it exists
  const _initGrid = window.initGrid;
  if(typeof _initGrid === 'function'){
    window.initGrid = function(){
      const r = _initGrid.apply(this, arguments);
      try{ window.applyTilePalette(); }catch(e){}
      return r;
    };
  }
  // Hook applyDesignForCurrentMode if it exists
  const _applyDFC = window.applyDesignForCurrentMode;
  if(typeof _applyDFC === 'function'){
    window.applyDesignForCurrentMode = function(){
      const r = _applyDFC.apply(this, arguments);
      try{ window.applyTilePalette(); }catch(e){}
      return r;
    };
  }
  function ensureTileDialog(){
    let dlg = document.getElementById('dlgTilePalette');
    if(dlg) return dlg;
    dlg = document.createElement('dialog');
    dlg.id = 'dlgTilePalette';
    dlg.innerHTML = [
      '<h3>Kachel‚ÄëFarben (8√ó8)</h3>',
      '<div class="grid-tiles" id="tilePaletteGrid"></div>',
      '<footer>',
        '<button class="btn" id="tilePaletteReset">Standard</button>',
        '<button class="btn primary" id="tilePaletteSave">Speichern</button>',
        '<button class="btn" id="tilePaletteClose">Schlie√üen</button>',
      '</footer>'
    ].join('');
    document.body.appendChild(dlg);
    dlg.querySelector('#tilePaletteClose').addEventListener('click', ()=> dlg.close());
    return dlg;
  }
  window.openTilePaletteEditor = function(modeKey){
    const mk = keyFor(modeKey);
    if(mk === 'ultra' || (mk !== 'low' && mk !== 'mid' && mk !== 'high')) return;
    const dlg = ensureTileDialog();
    const grid = dlg.querySelector('#tilePaletteGrid');
    grid.innerHTML = '';
    const arr = getTilePalette(mk) || Array(64).fill('');
    for(let i=0;i<64;i++){
      const inp = document.createElement('input');
      inp.type = 'color';
      let v = arr[i];
      if(!v){
        try{
          const el = window.tileEls && tileEls[i];
          if(el){
            const cs = getComputedStyle(el).backgroundColor;
            if(cs && cs.startsWith('rgb')){
              const m = cs.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
              if(m){
                const r = (+m[1]).toString(16).padStart(2,'0');
                const g = (+m[2]).toString(16).padStart(2,'0');
                const b = (+m[3]).toString(16).padStart(2,'0');
                v = '#' + r + g + b;
              }
            }
          }
        }catch(e){}
      }
      inp.value = v || '#000000';
      inp.dataset.idx = i;
      grid.appendChild(inp);
    }
    const btnReset = dlg.querySelector('#tilePaletteReset');
    const btnSave = dlg.querySelector('#tilePaletteSave');
    btnReset.onclick = function(){
      clearTilePalette(mk);
      try{ window.applyTilePalette(mk); }catch(e){}
      if(window.showToast) showToast('Kachel‚ÄëFarben zur√ºckgesetzt');
      dlg.close();
    };
    btnSave.onclick = function(){
      const picks = Array.from(grid.querySelectorAll('input[type="color"]'));
      const out = new Array(64).fill('');
      picks.forEach(inp => {
        const i = +inp.dataset.idx;
        out[i] = inp.value || '';
      });
      saveTilePalette(mk, out);
      try{ window.applyTilePalette(mk); }catch(e){}
      if(window.showToast) showToast('Kachel‚ÄëFarben gespeichert');
      dlg.close();
    };
    if(dlg.showModal) dlg.showModal();
  };
  // Try to place a "Kacheln f√§rben" button near common anchors if they exist
  document.addEventListener('DOMContentLoaded', function(){
    const addBtn = (afterId, mk) => {
      const anchor = document.getElementById(afterId);
      if(!anchor) return;
      const btn = document.createElement('button');
      btn.className = 'btn xsmall';
      btn.textContent = 'Kacheln f√§rben';
      btn.style.marginLeft = '8px';
      btn.addEventListener('click', (e)=>{ e.preventDefault(); openTilePaletteEditor(mk); });
      anchor.insertAdjacentElement('afterend', btn);
    };
    ['resetLow','resetMid','resetHigh'].forEach((id,idx)=> addBtn(id, idx===0?'low':idx===1?'mid':'high'));
  });
})();
</script>

<script>
// Re-apply tile palette whenever the board re-renders tiles (safe; style-only).
(function(){
  function getModeKey(){
    const dm = (document.body.getAttribute('data-mode')||'').toLowerCase();
    if(dm==='niedrig' || dm==='low') return 'low';
    if(dm==='mittel' || dm==='medium' || dm==='mid') return 'mid';
    if(dm==='hoch' || dm==='high') return 'high';
    return dm;
  }
  function getPaletteFor(mk){
    try{
      const key = mk==='low' ? 'design_low_tiles' : mk==='mid' ? 'design_mid_tiles' : mk==='high' ? 'design_high_tiles' : null;
      if(!key) return null;
      const raw = localStorage.getItem(key);
      if(!raw) return null;
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr.slice(0,64) : null;
    }catch(_){ return null; }
  }
  function applyToEls(els, arr){
    for(let i=0;i<els.length && i<64;i++){
      const el = els[i];
      if(!el || !el.style) continue;
      const c = arr && arr[i] || null;
      if(c){
        el.style.backgroundColor = c;
        try{ el.style.setProperty('background', 'linear-gradient(0deg,'+c+','+c+')', 'important'); }
        catch(_){ el.style.background = c; }
      }else{
        el.style.backgroundColor = '';
        try{ el.style.setProperty('background', '', 'important'); }catch(_){ el.style.background = ''; }
      }
    }
  }
  function repaint(){
    const mk = getModeKey();
    if(mk==='ultra') return; // Ultra unchanged
    const arr = getPaletteFor(mk);
    const board = document.getElementById('board');
    if(!board) return;
    // Prefer global tileEls if available and length matches
    const els = (window.tileEls && tileEls.length===64) ? tileEls : Array.from(board.querySelectorAll('.tile'));
    if(!els || !els.length) return;
    applyToEls(els, arr);
  }
  // Initial and on DOMContentLoaded
  try{ repaint(); }catch(_){}
  document.addEventListener('DOMContentLoaded', function(){ try{ repaint(); }catch(_){} });
  // Mutation observer for child changes
  const board = document.getElementById('board');
  if(board && window.MutationObserver){
    const mo = new MutationObserver(()=>{ try{ repaint(); }catch(_){} });
    mo.observe(board, { childList: true });
  }
  // Also repaint on window resize (some UIs rebuild tiles on resize)
  window.addEventListener('resize', function(){ try{ repaint(); }catch(_){} }, { passive: true });
})();
</script>

<div id="toastSave" role="status" aria-live="polite" aria-atomic="true">Gespeichert</div>
</body>
</html>
